<?xml version="1.0" encoding="EUC-KR"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="stat.space">
	<select id="retrieveSpaceYyList" resultType="hashmap">
	--retrieveSpaceYyList 년도조회
		<![CDATA[
		SELECT LEFT(CMPL_DT,4) AS yy
		  FROM IRIS_SPACE_RQPR_MST
		 WHERE 1=1
		   AND CMPL_DT IS NOT NULL
		   AND CMPL_DT !=''
		 GROUP BY LEFT(CMPL_DT,4)
		 ORDER BY LEFT(CMPL_DT,4) DESC
		 ]]>
	</select>

	<select id="getSpaceBzdvStatList" resultType="hashmap">
	--getSpaceBzdvStatList 담당자별통계 조회
		<![CDATA[
		select sa_user
      ,sa_name
	  ,INFM_PRSN_ID
      ,isnull(last_acpc,0) as last_acpc
	  ,isnull(this_all_acpc,0) as this_all_acpc
	  ,isnull(this_acpc,0) as this_acpc
	  ,isnull(this_ing,0) as this_ing
	  ,isnull(this_drop,0) as this_drop
	  ,isnull(this_cmpl,0) as this_cmpl
	  ,isnull(dd_avg,0) as dd_avg
	  ,isnull(cmpl_p,0) as cmpl_p
  from IRIS_SSO_USER ssouser
  left join (select INFM_PRSN_ID
				  ,last_acpc
				  ,this_all_acpc
				  ,this_acpc
				  ,this_ing
				  ,this_drop
				  ,this_cmpl
				  ,case when this_cmpl=0
						then 0
						else dd_cnt/this_cmpl
					end as dd_avg
				  ,case when this_cmpl=0
						then 0
						else round( this_cmpl/convert(float,(last_acpc+this_all_acpc))*100, 1)
					end as cmpl_p	--완료율
			  from	(select main.INFM_PRSN_ID
						  ,sum(main.this_all_acpc) as this_all_acpc
						  ,sum(main.this_acpc) as this_acpc
						  ,sum(main.last_acpc) as last_acpc
						  ,sum(main.this_ing) as this_ing
						  ,sum(main.this_cmpl) as this_cmpl
						  ,sum(main.this_drop) as this_drop
						  ,sum(DD_CNT) as DD_CNT
					  from (select crgr.INFM_PRSN_ID
								  ,mst.ACPC_DT
								  ,LEFT(CONVERT(nvarchar,mst.ACPC_DT,23),7) as thin_acpc_mon
								  ,LEFT(CONVERT(nvarchar, DATEADD(M, -1, ACPC_DT), 23),7) as last_acpc_mon
								  ,LEFT(CONVERT(nvarchar,mst.space_RDCS_DT,23),7) as this_cmpl_mon
								  ,LEFT(CONVERT(nvarchar,mst.space_DCAC_DT,23),7) as this_drop_mon
								  ,mst.space_ACPC_ST_CD
								  ,case when LEFT(CONVERT(nvarchar,mst.ACPC_DT,23),7) between #{fromCmplDt} and #{toCmplDt}
										then case when mst.space_ACPC_ST_CD in ('03','05','06','07','08')
												  then 1
												  else 0
											  end
										else 0
									end as this_all_acpc --평가접수
								  ,case when LEFT(CONVERT(nvarchar,mst.ACPC_DT,23),7) between #{fromCmplDt} and #{toCmplDt}
										then case when space_ACPC_ST_CD in ('03', '05', '06')
												  then 1
												  else 0
											  end
										else 0
									end as this_acpc --이번달 접수된건
								  ,case when LEFT(CONVERT(nvarchar,mst.ACPC_DT,23),7) = LEFT(CONVERT(nvarchar, DATEADD(M, -1, #{fromCmplDt}+'-01'), 23),7)
										then case when space_ACPC_ST_CD in ('03','05','06')
												  then 1
												  else 0
											  end
										else 0
									end as last_acpc --저번달 접수된 건중 완료가 되지않은 건(이월건)
								  ,case when LEFT(CONVERT(nvarchar,mst.CMPL_DT,23),7) between #{fromCmplDt} and #{toCmplDt}
										then case when space_ACPC_ST_CD in ('07', '08')
												  then 1
												  else 0
											  end
										else 0
									end as this_cmpl --평가완료건
								  ,case when LEFT(CONVERT(nvarchar,mst.ACPC_DT,23),7) between #{fromCmplDt} and #{toCmplDt}
										then case when space_ACPC_ST_CD in ('03', '06')
												  then 1
												  else 0
											  end
										else 0
									end as this_ing --평가진행
								  ,case when LEFT(CONVERT(nvarchar,mst.SPACE_DCAC_DT,23),7) between #{fromCmplDt} and #{toCmplDt}
										then case when space_ACPC_ST_CD = '05'
												  then 1
												  else 0
											  end
										else 0
									end as this_drop --평가중단
								  ,mst.CMPL_WK_DD_CNT
								  ,case when LEFT(CONVERT(nvarchar,mst.CMPL_DT,23),7) between #{fromCmplDt} and #{toCmplDt}
										then case when space_ACPC_ST_CD in ('07', '08')
												  then CMPL_WK_DD_CNT
												  else 0
											  end
										else 0
									end as DD_CNT
							  from IRIS_space_RQPR_MST mst
							 inner join IRIS_SPACE_WAY_CRGR crgr
								on mst.RQPR_ID=crgr.RQPR_ID
							 where 1=1
							   and mst.del_yn='N'
							   and crgr.del_yn='N'
							    and mst.space_ACPC_ST_CD not in ('00','01','02','04')) main
							   group by main.INFM_PRSN_ID) main2) main3
   on ssouser.sa_user=main3.INFM_PRSN_ID
where 1=1
  and ssouser.sa_dept_new='58162619'
  and ssouser.sa_func !='FO0'
		 ]]>
	</select>

	<select id="getSpaceEvAffrSttsList" resultType="hashmap">
	--getSpaceEvAffrSttsList 평가업무현황 조회
<![CDATA[
SELECT * FROM
(SELECT SPACE_UGY_YN
      ,SPACE_UGY_NM  --구분
      ,SPACE_SCN_CD
	  ,SPACE_SCN_NM  --상세구분
	  ,SPACE_SCN_ORD
	  ,SUM(CNT) AS CNT  --합계
	  ,ROUND(CAST(SUM(CNT)AS FLOAT) /12,1)  AS AVG_CNT  --월평균
	  ,SUM(DD_CNT) AS DD_CNT
	  ,MAX(AVG_DD) AVG_DD
      ,SUM(CASE WHEN MON = '01' THEN CNT END) AS M1
	  ,SUM(CASE WHEN MON = '02' THEN CNT END) AS M2
	  ,SUM(CASE WHEN MON = '03' THEN CNT END) AS M3
	  ,SUM(CASE WHEN MON = '04' THEN CNT END) AS M4
	  ,SUM(CASE WHEN MON = '05' THEN CNT END) AS M5
	  ,SUM(CASE WHEN MON = '06' THEN CNT END) AS M6
	  ,SUM(CASE WHEN MON = '07' THEN CNT END) AS M7
	  ,SUM(CASE WHEN MON = '08' THEN CNT END) AS M8
	  ,SUM(CASE WHEN MON = '09' THEN CNT END) AS M9
	  ,SUM(CASE WHEN MON = '10' THEN CNT END) AS M10
	  ,SUM(CASE WHEN MON = '11' THEN CNT END) AS M11
	  ,SUM(CASE WHEN MON = '12' THEN CNT END) AS M12
  FROM
(SELECT SUB1.MON
      ,SUB1.SPACE_UGY_YN
	  ,SUB1.SPACE_UGY_NM
	  ,SUB1.SPACE_SCN_CD
	  ,SUB1.SPACE_SCN_NM
	  ,SUB1.SPACE_UGY_ORD
	  ,SUB1.SPACE_SCN_ORD
	  ,ISNULL(SUB2.CMPL_WK_DD_CNT,0) AS DD_CNT
	  ,ISNULL(SUB2.CNT,0) AS CNT
	  ,ISNULL(SUB2.AVG_DD,0) AS AVG_DD
  FROM
(
SELECT ALLMON.MON
      ,COMCD1.COM_DTL_CD AS SPACE_UGY_YN
      ,COMCD1.COM_DTL_NM AS SPACE_UGY_NM
	  ,COMCD2.COM_DTL_CD AS SPACE_SCN_CD
      ,COMCD2.COM_DTL_NM AS SPACE_SCN_NM
	  ,COMCD1.COM_ORD AS SPACE_UGY_ORD
	  ,COMCD2.COM_ORD AS SPACE_SCN_ORD
  FROM (SELECT 'A' AS COM_DTL_CD
              ,'전체' AS COM_DTL_NM
			  ,0 AS COM_ORD) COMCD1
      ,IRIS_ADM_COM_CD COMCD2
	  ,(SELECT MON
  		  FROM (SELECT '01' AS MON
				UNION ALL
				SELECT '02' AS MON
				UNION ALL
				SELECT '03' AS MON
				UNION ALL
				SELECT '04' AS MON
				UNION ALL
				SELECT '05' AS MON
				UNION ALL
				SELECT '06' AS MON
				UNION ALL
				SELECT '07' AS MON
				UNION ALL
				SELECT '08' AS MON
				UNION ALL
				SELECT '09' AS MON
				UNION ALL
				SELECT '10' AS MON
				UNION ALL
				SELECT '11' AS MON
				UNION ALL
				SELECT '12' AS MON) MON ) ALLMON
 WHERE 1=1
   AND COMCD2.COM_CD_CD='SPACE_SCN_CD') SUB1
LEFT JOIN (SELECT CMPLMON
      ,'A' AS SPACE_UGY_YN
      ,SPACE_SCN_CD
	  ,SUM(CMPL_WK_DD_CNT) AS CMPL_WK_DD_CNT
	  ,COUNT(1) AS CNT
	  ,SUM(CMPL_WK_DD_CNT)/COUNT(1) AS AVG_DD
  FROM
(SELECT LEFT(CMPL_DT,4) AS CMPLYY
			  ,RIGHT(LEFT(CMPL_DT,7),2) AS CMPLMON
			  ,SPACE_ACPC_ST_CD
			  ,'A' AS SPACE_UGY_YN -- U,C 긴급, 일반
			  ,SPACE_SCN_CD --R,S,B,M,E 연구,Sec-in, 영업, 마케팅, 기타
			  ,CMPL_WK_DD_CNT
		  FROM IRIS_SPACE_RQPR_MST
		 WHERE 1=1
		   AND LEFT(CMPL_DT,4)=#{yyyy}
		   AND SPACE_ACPC_ST_CD IN ('07','08')) RQPRMST
 GROUP BY CMPLMON
      ,SPACE_UGY_YN
      ,SPACE_SCN_CD) SUB2
    ON SUB1.MON=SUB2.CMPLMON
   AND SUB1.SPACE_UGY_YN=SUB2.SPACE_UGY_YN
   AND SUB1.SPACE_SCN_CD=SUB2.SPACE_SCN_CD) MAIN
GROUP BY
	 SPACE_SCN_CD
	 ,SPACE_UGY_YN
	  ,SPACE_UGY_NM
	  ,SPACE_SCN_NM
	  ,SPACE_UGY_ORD
	  ,SPACE_SCN_ORD

	  UNION ALL

SELECT SPACE_UGY_YN
      ,SPACE_UGY_NM
      ,SPACE_SCN_CD
	  ,SPACE_SCN_NM
	  ,SPACE_SCN_ORD
	  ,SUM(CNT) AS CNT
	  ,ROUND(CAST(SUM(CNT)AS FLOAT) /12,1)  AS AVG_CNT
	  ,SUM(DD_CNT) AS DD_CNT
	  ,MAX(AVG_DD) AVG_DD
      ,SUM(CASE WHEN MON = '01' THEN CNT END) AS M1
	  ,SUM(CASE WHEN MON = '02' THEN CNT END) AS M2
	  ,SUM(CASE WHEN MON = '03' THEN CNT END) AS M3
	  ,SUM(CASE WHEN MON = '04' THEN CNT END) AS M4
	  ,SUM(CASE WHEN MON = '05' THEN CNT END) AS M5
	  ,SUM(CASE WHEN MON = '06' THEN CNT END) AS M6
	  ,SUM(CASE WHEN MON = '07' THEN CNT END) AS M7
	  ,SUM(CASE WHEN MON = '08' THEN CNT END) AS M8
	  ,SUM(CASE WHEN MON = '09' THEN CNT END) AS M9
	  ,SUM(CASE WHEN MON = '10' THEN CNT END) AS M10
	  ,SUM(CASE WHEN MON = '11' THEN CNT END) AS M11
	  ,SUM(CASE WHEN MON = '12' THEN CNT END) AS M12
  FROM
(SELECT SUB1.MON
      ,SUB1.SPACE_UGY_YN
	  ,SUB1.SPACE_UGY_NM
	  ,SUB1.SPACE_SCN_CD
	  ,SUB1.SPACE_SCN_NM
	  ,SUB1.SPACE_UGY_ORD
	  ,SUB1.SPACE_SCN_ORD
	  ,ISNULL(SUB2.CMPL_WK_DD_CNT,0) AS DD_CNT
	  ,ISNULL(SUB2.CNT,0) AS CNT
	  ,ISNULL(SUB2.AVG_DD,0) AS AVG_DD
  FROM
(SELECT ALLMON.MON
      ,COMCD1.COM_DTL_CD AS SPACE_UGY_YN
      ,COMCD1.COM_DTL_NM AS SPACE_UGY_NM
	  ,COMCD2.COM_DTL_CD AS SPACE_SCN_CD
      ,COMCD2.COM_DTL_NM AS SPACE_SCN_NM
	  ,COMCD1.COM_ORD AS SPACE_UGY_ORD
	  ,COMCD2.COM_ORD AS SPACE_SCN_ORD
  FROM IRIS_ADM_COM_CD COMCD1
      ,IRIS_ADM_COM_CD COMCD2
	  ,(SELECT MON
  		  FROM (SELECT '01' AS MON
				UNION ALL
				SELECT '02' AS MON
				UNION ALL
				SELECT '03' AS MON
				UNION ALL
				SELECT '04' AS MON
				UNION ALL
				SELECT '05' AS MON
				UNION ALL
				SELECT '06' AS MON
				UNION ALL
				SELECT '07' AS MON
				UNION ALL
				SELECT '08' AS MON
				UNION ALL
				SELECT '09' AS MON
				UNION ALL
				SELECT '10' AS MON
				UNION ALL
				SELECT '11' AS MON
				UNION ALL
				SELECT '12' AS MON) MON ) ALLMON
 WHERE 1=1
   AND COMCD1.COM_CD_CD='ANL_UGY_YN'
   AND COMCD2.COM_CD_CD='SPACE_SCN_CD') SUB1
LEFT JOIN (SELECT CMPLMON
      ,SPACE_UGY_YN
      ,SPACE_SCN_CD
	  ,SUM(CMPL_WK_DD_CNT) AS CMPL_WK_DD_CNT
	  ,COUNT(1) AS CNT
	  ,SUM(CMPL_WK_DD_CNT)/COUNT(1) AS AVG_DD
  FROM
(SELECT LEFT(CMPL_DT,4) AS CMPLYY
			  ,RIGHT(LEFT(CMPL_DT,7),2) AS CMPLMON
			  ,SPACE_ACPC_ST_CD
			  ,SPACE_UGY_YN -- U,C 긴급, 일반
			  ,SPACE_SCN_CD --R,S,B,M,E 연구,Sec-in, 영업, 마케팅, 기타
			  ,CMPL_WK_DD_CNT
		  FROM IRIS_SPACE_RQPR_MST
		 WHERE 1=1
		   AND LEFT(CMPL_DT,4)=#{yyyy}
		   AND SPACE_ACPC_ST_CD IN ('07','08')) RQPRMST
 GROUP BY CMPLMON
      ,SPACE_UGY_YN
      ,SPACE_SCN_CD) SUB2
    ON SUB1.MON=SUB2.CMPLMON
   AND SUB1.SPACE_UGY_YN=SUB2.SPACE_UGY_YN
   AND SUB1.SPACE_SCN_CD=SUB2.SPACE_SCN_CD) MAIN
GROUP BY
	 SPACE_SCN_CD
	 ,SPACE_UGY_YN
	  ,SPACE_UGY_NM
	  ,SPACE_SCN_NM
	  ,SPACE_UGY_ORD
	  ,SPACE_SCN_ORD) TOTAL
	  ORDER BY SPACE_UGY_YN,SPACE_SCN_ORD
]]>
</select>
</mapper>