<?xml version="1.0" encoding="EUC-KR"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="stat.prj">
    <select id="retrieveGenTssStatList" resultType="hashmap">
    <![CDATA[
        --retrieveGenTssStatList
		WITH TSS_LIST AS (
			select   a.PRJ_CD
					,a.TSS_CD
					,left(a.tss_cd,9)+'2' as pgTss_cd
					,a.TSS_NM
					,a.WBS_CD
					,a.PK_WBS_CD
					,a.PGS_STEP_CD
					,a.BIZ_DPT_CD
					,a.TSS_ATTR_CD
					,a.PROD_G
					,a.PPSL_MBD_CD
					,a.RSST_SPHE
					,a.TSS_TYPE
					,a.TSS_ST
					,a.dept_code
					,a.sa_sabun_new
					,a.sa_sabun_name
					,a.dept_name as asDeptName
					,substring(a.PRJ_NM, CHARINDEX ('.', a.PRJ_NM) +1, len(a.PRJ_NM))  as asPrjNm
					,a.TSS_STRT_DD
					,a.TSS_FNH_DD
					,a.CMPL_B_STRT_DD
					,a.CMPL_B_FNH_DD
					,a.DCAC_B_STRT_DD
					,a.DCAC_B_FNH_DD
			from   IRIS_TSS_MGMT_MST a
			where  a.DEL_YN ='N'
			and    a.TSS_SCN_CD ='G'
			and    a.prj_cd <> 'PRJ00004'
			and    a.tss_cd in (SELECT TSS_CD
								FROM (SELECT PK_WBS_CD, TSS_CD, STEPRANK
											, RANK() OVER (PARTITION BY X.PK_WBS_CD ORDER BY X.STEPRANK ASC, TSS_CD DESC) AS OVER_STEP_RANK
										FROM (SELECT CASE WHEN PGS_STEP_CD = 'CM' OR PGS_STEP_CD = 'DC' THEN 1
														WHEN PGS_STEP_CD = 'PG' AND TSS_ST = '100' THEN 2
														WHEN PGS_STEP_CD = 'PG' AND (TSS_ST = '101' OR TSS_ST = '102') THEN 3
														WHEN PGS_STEP_CD = 'AL' THEN 4
														WHEN PGS_STEP_CD = 'PG' AND TSS_ST != '100' THEN 5
														WHEN PGS_STEP_CD = 'PL' THEN 6 END AS STEPRANK
													, TSS_CD, PGS_STEP_CD, TSS_ST, PK_WBS_CD
												FROM IRIS_TSS_MGMT_MST
												where tss_scn_cd ='G' ) X) Y
										WHERE OVER_STEP_RANK = 1
										)
			and   a.PGS_STEP_CD <> 'PL'
			--and   a.wbs_cd ='C15HR1'
		)

		select  m.*
		from  (
				select   a.tss_cd
				        ,a.WBS_CD as wbsCd
						,isnull(a.asDeptName, (select dept_name from IRIS_SSO_DEPT where dept_code = (select dept_uper from IRIS_PRJ_RSST_MST where prj_cd = a.PRJ_CD))) as deptName
						,isnull(a.asPrjNm, (select substring(prj_nm, CHARINDEX ('.', prj_nm) +1, len(prj_nm)  ) as prj_nm from IRIS_PRJ_RSST_MST where prj_cd = a.PRJ_CD) )as prjNm
						,dbo.fn_getComDtlNm('BIZ_DPT_CD', a.BIZ_DPT_CD)                           AS bizDptCd
						,dbo.fn_getComDtlNm('TSS_ATTR_CD', a.TSS_ATTR_CD)                         AS tssAttrCd    --과제속성
						,dbo.fn_getComDtlNm('PROD_G', a.PROD_G)                                   AS prodG        --제품군
						,dbo.fn_getComDtlNm('PPSL_MBD_CD', a.PPSL_MBD_CD)                         AS ppslMbdCd    --발의주체
						,a.TSS_NM as tssNm
						,dbo.fn_getComDtlNm('RSST_SPHE', a.RSST_SPHE)                             AS rsstSphe     --연구분야
						,dbo.fn_getComDtlNm('TSS_TYPE', a.TSS_TYPE)                               AS tssType      --과제유형
						,isnull(dbo.fn_getSabunName(a.SA_SABUN_NEW) , a.sa_sabun_name)            AS saUserName   --과제리더명
						,a.TSS_STRT_DD                                                            AS tssStrtDd    --과제기간시작
						,a.TSS_FNH_DD                                                             AS tssFnhDdPln  --과제종료일-계획
						,CASE WHEN a.PGS_STEP_CD = 'DC' THEN a.DCAC_B_FNH_DD
							  WHEN a.PGS_STEP_CD = 'CM' THEN a.CMPL_B_FNH_DD END                  AS tssFnhDdArsl --과제종료일-실적
						,DATEDIFF(MM, a.TSS_STRT_DD, a.TSS_FNH_DD)+1                              AS wnedTrmPln   --소요기간-계획
						,CASE WHEN a.PGS_STEP_CD = 'DC' THEN DATEDIFF(MM, a.TSS_STRT_DD, a.DCAC_B_FNH_DD)+1
							  WHEN a.PGS_STEP_CD = 'CM' THEN DATEDIFF(MM, a.TSS_STRT_DD, a.CMPL_B_FNH_DD)+1 END AS wnedTrmArsl  --소요기간-실적
						,isnull(left(b.CTY_OT_PLN_M, 4), left(c.CTY_OT_PLN_M, 4))  AS ctyOtPlnY    --상품출시년도
						,isnull(right(b.CTY_OT_PLN_M, 2), right(c.CTY_OT_PLN_M, 2)) AS ctyOtPlnM    --상품출시월
						,isnull(left(d.LNCH_YM, 4), left(d.LNCH_YM, 4))  AS ctyOtY    --상품출시년도실적
						,isnull(right(d.LNCH_YM, 2), right(d.LNCH_YM, 2)) AS ctyOtM    --상품출시월실적
						,dbo.fn_getComDtlNm('TSS_ST',a.TSS_ST)                                    AS tssStNm      --상태명
						,dbo.fn_getComDtlNm('PGS_STEP_CD', a.PGS_STEP_CD)                          AS pgsStepNm   --진행상태명
						,b.ANCP_OT_PLN_DT                                                         AS ancpOtPlnDt  --예상출시계획일
						,b.Qgate3_DT                                                              AS qgate3Dt     --Q-gate일자
						,b.DCAC_RSON_TXT                                                          AS dcacRsonTxt  --중단사유
						,isnull(b.NPROD_SALS_PLN_Y  , c.NPROD_SALS_PLN_Y   ) AS nprodSalsPlnY    --매출계획Y
						,isnull(b.NPROD_SALS_PLN_Y_1, c.NPROD_SALS_PLN_Y_1 ) AS nprodSalsPlnY1   --매출계획Y1
						,isnull(b.NPROD_SALS_PLN_Y_2, c.NPROD_SALS_PLN_Y_2 ) AS nprodSalsPlnY2   --매출계획Y2
						,isnull(b.NPROD_SALS_PLN_Y_3, c.NPROD_SALS_PLN_Y_3 ) AS nprodSalsPlnY3   --매출계획Y3
						,isnull(b.NPROD_SALS_PLN_Y_4, c.NPROD_SALS_PLN_Y_4 ) AS nprodSalsPlnY4   --매출계획Y4
						,isnull((b.NPROD_SALS_PLN_Y + b.NPROD_SALS_PLN_Y_1 + b.NPROD_SALS_PLN_Y_2 + b.NPROD_SALS_PLN_Y_3 + b.NPROD_SALS_PLN_Y_4)
							   , (c.NPROD_SALS_PLN_Y + c.NPROD_SALS_PLN_Y_1 + c.NPROD_SALS_PLN_Y_2 + c.NPROD_SALS_PLN_Y_3 + c.NPROD_SALS_PLN_Y_4) )  AS nprodSalsPlnSum --5년평균
						,isnull(d.yy,0) as nprodSalsY
						,isnull(d.yy1,0) as nprodSalsY1
						,isnull(d.yy2,0) as nprodSalsY2
						,isnull(d.yy3,0) as nprodSalsY3
						,isnull(d.yy4,0) as nprodSalsY4
						,isnull(d.AVG_YY,0) as nprodSalsSum
						,ROUND((SELECT SUM(X.PLN_EXP) / 100 FROM IRIS_TSS_GEN_TRWI_BUDG_LIST X WHERE X.TSS_CD = c.TSS_CD AND left(X.YY_MM,4)  = left( #{condYy}, 4)), 1)  AS yYPlnExp        --비용Y년-계획
						,ROUND((SELECT SUM(X.ARSL_EXP) / 100  FROM IRIS_TSS_GEN_TRWI_BUDG_LIST X WHERE X.TSS_CD = c.TSS_CD AND left(X.YY_MM,4) = left( #{condYy}, 4) ), 1) AS yYArslExp       --비용Y년-실적
						,ROUND((SELECT SUM(X.ARSL_EXP) / 100 FROM IRIS_TSS_GEN_TRWI_BUDG_LIST X WHERE X.TSS_CD = c.TSS_CD), 1)  AS allArslExp --비용총합-실적
						,ROUND((SELECT SUM(X.PLN_EXP) / 100 FROM IRIS_TSS_GEN_TRWI_BUDG_LIST X WHERE X.TSS_CD = c.TSS_CD), 1)   AS allPlnExp  --비용총합-계획
						,(
							select a.ptcCpsn
							from (
									select  left(x.TSS_STRT_DD, 4) as yyyy
										   ,y.PTC_CPSN_Y as ptcCpsn
									from   IRIS_TSS_MGMT_MST x
										   inner join IRIS_TSS_GEN_SMRY y
										   on y.TSS_CD = x.TSS_CD
									where  del_yn ='N'
									and    x.tss_cd = a.pgTss_cd
									union all
									select left(TSS_STRT_DD, 4)+1 as yyyy
										   ,y.PTC_CPSN_Y_1 as ptcCpsn
									from   IRIS_TSS_MGMT_MST x
										   inner join IRIS_TSS_GEN_SMRY y
										   on y.TSS_CD = x.TSS_CD
									where  del_yn ='N'
									and    x.tss_cd = a.pgTss_cd
									union all
									select left(TSS_STRT_DD, 4)+2 as yyyy
										  ,y.PTC_CPSN_Y_2 as ptcCpsn
									from   IRIS_TSS_MGMT_MST x
										   inner join IRIS_TSS_GEN_SMRY y
										   on y.TSS_CD = x.TSS_CD
									where  del_yn ='N'
									and    x.tss_cd = a.pgTss_cd
									union all
									select left(TSS_STRT_DD, 4)+3 as yyyy
										  ,y.PTC_CPSN_Y_3 as ptcCpsn
									from   IRIS_TSS_MGMT_MST x
										   inner join IRIS_TSS_GEN_SMRY y
										   on y.TSS_CD = x.TSS_CD
									where  del_yn ='N'
									and    x.tss_cd = a.pgTss_cd
									union all
									select left(TSS_STRT_DD, 4)+4 as yyyy
										  ,y.PTC_CPSN_Y_4 as ptcCpsn
									from   IRIS_TSS_MGMT_MST x
										   inner join IRIS_TSS_GEN_SMRY y
										   on y.TSS_CD = x.TSS_CD
									where  del_yn ='N'
									and    x.tss_cd = a.pgTss_cd
									) a
							where yyyy = #{condYy}
							)  AS mbrCntPln  --투입인원Y년-계획
						,round(isnull((select round((sum(PTC_PRO) / 100) / (select case when count(distinct mm_yymm) = 0 then 1 else count(distinct mm_yymm) end  from IRIS_MM_CLS where tss_cd = a.pgTss_cd and cls_yn ='Y' and left(MM_YYMM, 4) = #{condYy} ) , 2) from IRIS_MM_CLS where tss_cd  = a.pgTss_cd and left(MM_YYMM, 4) = #{condYy} and cls_yn ='Y'), 0), 1) AS mbrCntArsl --투입인원Y년-실적
						,#{condYy} as searchYy
						,d.MIN_YY AS minYy
				from    TSS_LIST a
						inner join IRIS_TSS_GEN_SMRY b
						on b.tss_cd = a.tss_cd
						left outer join IRIS_TSS_GEN_SMRY c
						on c.tss_cd = a.pgTss_cd
						left outer join (SELECT NP_CD
											  ,MIN(MIN_YY) AS MIN_YY
											  ,MIN(LNCH_YM) AS LNCH_YM
											  ,SUM(CASE WHEN LEFT(YM,4) =  MIN_YY THEN SAL_SUM_AMT ELSE 0 END) AS YY
											  ,SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+1 THEN SAL_SUM_AMT ELSE 0 END) AS YY1
											  ,SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+2 THEN SAL_SUM_AMT ELSE 0 END) AS YY2
											  ,SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+3 THEN SAL_SUM_AMT ELSE 0 END) AS YY3
											  ,SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+4 THEN SAL_SUM_AMT ELSE 0 END) AS YY4
											  ,CASE WHEN (CASE WHEN SUM(CASE WHEN LEFT(YM,4) =  MIN_YY THEN SAL_SUM_AMT ELSE 0 END) = 0
																THEN 0
																ELSE 1
															END
														  + CASE WHEN SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+1 THEN SAL_SUM_AMT ELSE 0 END) = 0
																THEN 0
																ELSE 1
															END
														  + CASE WHEN SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+2 THEN SAL_SUM_AMT ELSE 0 END) = 0
																THEN 0
																ELSE 1
															END
														  + CASE WHEN SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+3 THEN SAL_SUM_AMT ELSE 0 END) = 0
																THEN 0
																ELSE 1
															END
														  + CASE WHEN SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+4 THEN SAL_SUM_AMT ELSE 0 END) = 0
																THEN 0
																ELSE 1
															END) = 0
													THEN 0
												ELSE (SUM(CASE WHEN LEFT(YM,4) = MIN_YY THEN SAL_SUM_AMT ELSE 0 END)
													   +SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+1 THEN SAL_SUM_AMT ELSE 0 END)
													   +SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+2 THEN SAL_SUM_AMT ELSE 0 END)
													   +SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+3 THEN SAL_SUM_AMT ELSE 0 END)
													   +SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+4 THEN SAL_SUM_AMT ELSE 0 END))
													 /(CASE WHEN SUM(CASE WHEN LEFT(YM,4) =  MIN_YY THEN SAL_SUM_AMT ELSE 0 END) = 0
																THEN 0
																ELSE 1
															END
														  + CASE WHEN SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+1 THEN SAL_SUM_AMT ELSE 0 END) = 0
																THEN 0
																ELSE 1
															END
														  + CASE WHEN SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+2 THEN SAL_SUM_AMT ELSE 0 END) = 0
																THEN 0
																ELSE 1
															END
														  + CASE WHEN SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+3 THEN SAL_SUM_AMT ELSE 0 END) = 0
																THEN 0
																ELSE 1
															END
														  + CASE WHEN SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+4 THEN SAL_SUM_AMT ELSE 0 END) = 0
																THEN 0
																ELSE 1
															END)
												END AVG_YY
										  FROM (SELECT MST.NP_CD
													  ,MST.PJT_NM
													  ,MST.LNCH_YM
													  ,MST.YM
													  ,MST.SAL_SUM_AMT AS SAL_AMT
													  ,YYCNT.CNT
													  ,MST.SAL_SUM_AMT/CONVERT(FLOAT,YYCNT.CNT) AS SAL_SUM_AMT
													  ,(select LEFT(min(sub.YM),4) from IRIS_NEW_PRDT_SAL_STAT sub where sub.np_cd=MST.np_cd) MIN_YY
												  from IRIS_NEW_PRDT_SAL_STAT MST
												      ,(select pjt_nm
															  ,YM
															  ,count(1) over (partition by pjt_nm,YM) as cnt
														  from (select np_cd
																	  ,pjt_nm
																	  ,YM
																  from IRIS_NEW_PRDT_SAL_STAT
																 where 1=1
																 group by np_cd ,pjt_nm,YM) CNT ) YYCNT
														 WHERE 1=1
														   AND MST.PJT_NM=YYCNT.PJT_NM
														   AND MST.YM=YYCNT.YM) MST
										 WHERE 1=1
										GROUP BY  NP_CD) d
						on a.wbs_cd=d.np_cd
				where   1=1
				and     #{condYy} BETWEEN LEFT(a.TSS_STRT_DD, 4) AND LEFT(    (case when   a.PGS_STEP_CD = 'CM' then a.CMPL_B_FNH_DD
				                                                                                                                   when   a.PGS_STEP_CD = 'DC' then a.DCAC_B_FNH_DD 
																																   else    a.TSS_FNH_DD end ) , 4)
				) m
		]]>
        	WHERE  1=1
        	and   (left(m.tssFnhDdArsl ,4) >= #{condYy} or m.tssFnhDdArsl is null)
        	<if test="_roleId == 'WORK_IRI_T16' ">
	  		AND   deptName like '%'+#{_userDeptName}+'%'
        	</if>
		order by m.deptName, m.prjNm
    </select>

    <select id="retrieveGenTssStatDtlPopList" resultType="hashmap">
    <![CDATA[
        --retrieveGenTssStatDtlPopList
		select npCd
		      ,CASE WHEN GROUPING(nm) = 1
            		THEN '합계'
					ELSE nm
			    END  as nm
			  ,sum(m1) as m1
			  ,sum(m2) as m2
			  ,sum(m3) as m3
			  ,sum(m4) as m4
			  ,sum(m5) as m5
			  ,sum(m6) as m6
			  ,sum(m7) as m7
			  ,sum(m8) as m8
			  ,sum(m9) as m9
			  ,sum(m10) as m10
			  ,sum(m11) as m11
			  ,sum(m12) as m12
			  ,sum(totSum) as totSum
		 from
			(
			select np_cd as npCd
				  ,CASE WHEN GROUPING(pjt_nm) = 1
	            		THEN '합계'
						ELSE pjt_nm
				    END  as nm
				  ,round(sum(case when mm =  '01' then sal_sum_amt else 0 end)/convert(float,100000000),2) as m1
				  ,round(sum(case when mm =  '02' then sal_sum_amt else 0 end)/convert(float,100000000),2) as m2
				  ,round(sum(case when mm =  '03' then sal_sum_amt else 0 end)/convert(float,100000000),2) as m3
				  ,round(sum(case when mm =  '04' then sal_sum_amt else 0 end)/convert(float,100000000),2) as m4
				  ,round(sum(case when mm =  '05' then sal_sum_amt else 0 end)/convert(float,100000000),2) as m5
				  ,round(sum(case when mm =  '06' then sal_sum_amt else 0 end)/convert(float,100000000),2) as m6
				  ,round(sum(case when mm =  '07' then sal_sum_amt else 0 end)/convert(float,100000000),2) as m7
				  ,round(sum(case when mm =  '08' then sal_sum_amt else 0 end)/convert(float,100000000),2) as m8
				  ,round(sum(case when mm =  '09' then sal_sum_amt else 0 end)/convert(float,100000000),2) as m9
				  ,round(sum(case when mm =  '10' then sal_sum_amt else 0 end)/convert(float,100000000),2) as m10
				  ,round(sum(case when mm =  '11' then sal_sum_amt else 0 end)/convert(float,100000000),2) as m11
				  ,round(sum(case when mm =  '12' then sal_sum_amt else 0 end)/convert(float,100000000),2) as m12
				  ,round(sum(sal_sum_amt)/convert(float,100000000),2) as totSum
			  from
			(select np_cd
				  ,pjt_nm
				  ,lnch_ym
				  ,exp_lnch_ym
				  ,ym
				  ,right(ym,2) as mm
				  ,count(1) over (partition by pjt_nm,ym) as cnt
				  ,convert(float,sal_sum_amt)/count(1) over (partition by pjt_nm,ym) as sal_sum_amt
			  from iris_new_prdt_sal_stat
			 where 1=1
					   and left(ym,4)=#{yy}
					   and np_cd=#{npCd}) main
			  		  group by np_cd ,pjt_nm) mm
		  group by rollup((npCd ,nm))
		]]>
    </select>

    <select id="retrieveTctmStatList" resultType="hashmap">
    <![CDATA[
 --retrieveTechTeamTssStatList
		WITH TSS_LIST AS (
			select   a.PRJ_CD
					,a.TSS_CD
					,left(a.tss_cd,9)+'2' as pgTss_cd
					,a.TSS_NM
					,a.WBS_CD
					,a.PK_WBS_CD
					,a.PGS_STEP_CD
					,a.BIZ_DPT_CD
					,a.TSS_ATTR_CD
					,a.PROD_G
					,a.PPSL_MBD_CD
					,a.RSST_SPHE
					,a.TSS_TYPE
					,a.TSS_ST
					,a.dept_code
					,a.sa_sabun_new
					,a.sa_sabun_name
					,a.dept_name as asDeptName
					,substring(a.PRJ_NM, CHARINDEX ('.', a.PRJ_NM) +1, len(a.PRJ_NM))  as asPrjNm
					,a.TSS_STRT_DD
					,a.TSS_FNH_DD
					,a.CMPL_B_STRT_DD
					,a.CMPL_B_FNH_DD
					,a.DCAC_B_STRT_DD
					,a.DCAC_B_FNH_DD
			from   IRIS_TSS_MGMT_MST a
			where  a.DEL_YN ='N'
			and    a.TSS_SCN_CD ='D'
			and    a.prj_cd <> 'PRJ00004'
			and    a.tss_cd in (SELECT TSS_CD
								FROM (SELECT PK_WBS_CD, TSS_CD, STEPRANK
											, RANK() OVER (PARTITION BY X.PK_WBS_CD ORDER BY X.STEPRANK ASC, TSS_CD DESC) AS OVER_STEP_RANK
										FROM (SELECT CASE WHEN PGS_STEP_CD = 'CM' OR PGS_STEP_CD = 'DC' THEN 1
														WHEN PGS_STEP_CD = 'PG' AND TSS_ST = '100' THEN 2
														WHEN PGS_STEP_CD = 'PG' AND (TSS_ST = '101' OR TSS_ST = '102') THEN 3
														WHEN PGS_STEP_CD = 'AL' THEN 4
														WHEN PGS_STEP_CD = 'PG' AND TSS_ST != '100' THEN 5
														WHEN PGS_STEP_CD = 'PL' THEN 6 END AS STEPRANK
													, TSS_CD, PGS_STEP_CD, TSS_ST, PK_WBS_CD
												FROM IRIS_TSS_MGMT_MST
												where tss_scn_cd ='D' ) X) Y
										WHERE OVER_STEP_RANK = 1
										)
			and   a.PGS_STEP_CD <> 'PL'
			--and   a.wbs_cd ='C15HR1'
		)

		select  m.*
		from  (
				select   a.tss_cd
				        ,a.WBS_CD as wbsCd
						,isnull(a.asDeptName, (select dept_name from IRIS_SSO_DEPT where dept_code = (select dept_uper from IRIS_PRJ_RSST_MST where prj_cd = a.PRJ_CD))) as deptName
						,isnull(a.asPrjNm, (select substring(prj_nm, CHARINDEX ('.', prj_nm) +1, len(prj_nm)  ) as prj_nm from IRIS_PRJ_RSST_MST where prj_cd = a.PRJ_CD) )as prjNm
						,dbo.fn_getComDtlNm('BIZ_DPT_CD', a.BIZ_DPT_CD)                           AS bizDptCd
						,dbo.fn_getComDtlNm('TSS_ATTR_CD', a.TSS_ATTR_CD)                         AS tssAttrCd    --과제속성
						,dbo.fn_getComDtlNm('PROD_G', a.PROD_G)                                   AS prodG        --제품군
						,dbo.fn_getComDtlNm('PPSL_MBD_CD', a.PPSL_MBD_CD)                         AS ppslMbdCd    --발의주체
						,a.TSS_NM as tssNm
						,dbo.fn_getComDtlNm('RSST_SPHE', a.RSST_SPHE)                             AS rsstSphe     --연구분야
						,dbo.fn_getComDtlNm('TSS_TYPE', a.TSS_TYPE)                               AS tssType      --과제유형
						,dbo.fn_getSabunName(a.SA_SABUN_NEW)                                      AS saUserName   --과제리더명
						,a.TSS_STRT_DD                                                            AS tssStrtDd    --과제기간시작
						,a.TSS_FNH_DD                                                             AS tssFnhDdPln  --과제종료일-계획
						,CASE WHEN a.PGS_STEP_CD = 'DC' THEN a.DCAC_B_FNH_DD
							  WHEN a.PGS_STEP_CD = 'CM' THEN a.CMPL_B_FNH_DD END                  AS tssFnhDdArsl --과제종료일-실적
						,DATEDIFF(MM, a.TSS_STRT_DD, a.TSS_FNH_DD)+1                              AS wnedTrmPln   --소요기간-계획
						,CASE WHEN a.PGS_STEP_CD = 'DC' THEN DATEDIFF(MM, a.TSS_STRT_DD, a.DCAC_B_FNH_DD)+1
							  WHEN a.PGS_STEP_CD = 'CM' THEN DATEDIFF(MM, a.TSS_STRT_DD, a.CMPL_B_FNH_DD)+1 END AS wnedTrmArsl  --소요기간-실적
						,isnull(left(b.CTY_OT_PLN_M, 4), left(c.CTY_OT_PLN_M, 4))  AS ctyOtPlnY    --상품출시년도
						,isnull(right(b.CTY_OT_PLN_M, 2), right(c.CTY_OT_PLN_M, 2)) AS ctyOtPlnM    --상품출시월
						,isnull(left(d.LNCH_YM, 4), left(d.LNCH_YM, 4))  AS ctyOtY    --상품출시년도실적
						,isnull(right(d.LNCH_YM, 2), right(d.LNCH_YM, 2)) AS ctyOtM    --상품출시월실적
						,dbo.fn_getComDtlNm('TSS_ST',a.TSS_ST)                                    AS tssStNm      --상태명
						,dbo.fn_getComDtlNm('PGS_STEP_CD', a.PGS_STEP_CD)                          AS pgsStepNm   --진행상태명
						,b.ANCP_OT_PLN_DT                                                         AS ancpOtPlnDt  --예상출시계획일
						,b.Qgate3_DT                                                              AS qgate3Dt     --Q-gate일자
						,b.DCAC_RSON_TXT                                                          AS dcacRsonTxt  --중단사유
						,isnull(b.NPROD_SALS_PLN_Y  , c.NPROD_SALS_PLN_Y   ) AS nprodSalsPlnY    --매출계획Y
						,#{condYy} as searchYy
						,d.MIN_YY as minYy
				from    TSS_LIST a
						inner join IRIS_TSS_TCTM_SMRY b
						on b.tss_cd = a.tss_cd
						left outer join IRIS_TSS_TCTM_SMRY c
						on c.tss_cd = a.pgTss_cd
						left outer join (SELECT NP_CD
											  ,MIN(MIN_YY) AS MIN_YY
											  ,MIN(LNCH_YM) AS LNCH_YM
											  ,SUM(CASE WHEN LEFT(YM,4) =  MIN_YY THEN SAL_SUM_AMT ELSE 0 END) AS YY
											  ,SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+1 THEN SAL_SUM_AMT ELSE 0 END) AS YY1
											  ,SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+2 THEN SAL_SUM_AMT ELSE 0 END) AS YY2
											  ,SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+3 THEN SAL_SUM_AMT ELSE 0 END) AS YY3
											  ,SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+4 THEN SAL_SUM_AMT ELSE 0 END) AS YY4
											  ,CASE WHEN (CASE WHEN SUM(CASE WHEN LEFT(YM,4) =  MIN_YY THEN SAL_SUM_AMT ELSE 0 END) = 0
																THEN 0
																ELSE 1
															END
														  + CASE WHEN SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+1 THEN SAL_SUM_AMT ELSE 0 END) = 0
																THEN 0
																ELSE 1
															END
														  + CASE WHEN SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+2 THEN SAL_SUM_AMT ELSE 0 END) = 0
																THEN 0
																ELSE 1
															END
														  + CASE WHEN SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+3 THEN SAL_SUM_AMT ELSE 0 END) = 0
																THEN 0
																ELSE 1
															END
														  + CASE WHEN SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+4 THEN SAL_SUM_AMT ELSE 0 END) = 0
																THEN 0
																ELSE 1
															END) = 0
													THEN 0
												ELSE (SUM(CASE WHEN LEFT(YM,4) = MIN_YY THEN SAL_SUM_AMT ELSE 0 END)
													   +SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+1 THEN SAL_SUM_AMT ELSE 0 END)
													   +SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+2 THEN SAL_SUM_AMT ELSE 0 END)
													   +SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+3 THEN SAL_SUM_AMT ELSE 0 END)
													   +SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+4 THEN SAL_SUM_AMT ELSE 0 END))
													 /(CASE WHEN SUM(CASE WHEN LEFT(YM,4) =  MIN_YY THEN SAL_SUM_AMT ELSE 0 END) = 0
																THEN 0
																ELSE 1
															END
														  + CASE WHEN SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+1 THEN SAL_SUM_AMT ELSE 0 END) = 0
																THEN 0
																ELSE 1
															END
														  + CASE WHEN SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+2 THEN SAL_SUM_AMT ELSE 0 END) = 0
																THEN 0
																ELSE 1
															END
														  + CASE WHEN SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+3 THEN SAL_SUM_AMT ELSE 0 END) = 0
																THEN 0
																ELSE 1
															END
														  + CASE WHEN SUM(CASE WHEN LEFT(YM,4) =  MIN_YY+4 THEN SAL_SUM_AMT ELSE 0 END) = 0
																THEN 0
																ELSE 1
															END)
												END AVG_YY
										  FROM (SELECT MST.NP_CD
													  ,MST.PJT_NM
													  ,MST.LNCH_YM
													  ,MST.YM
													  ,MST.SAL_SUM_AMT AS SAL_AMT
													  ,YYCNT.CNT
													  ,MST.SAL_SUM_AMT/CONVERT(FLOAT,YYCNT.CNT) AS SAL_SUM_AMT
													  ,(select LEFT(min(sub.YM),4) from IRIS_NEW_PRDT_SAL_STAT sub where sub.np_cd=MST.np_cd) MIN_YY
												  from IRIS_NEW_PRDT_SAL_STAT MST
												      ,(select pjt_nm
															  ,YM
															  ,count(1) over (partition by pjt_nm,YM) as cnt
														  from (select np_cd
																	  ,pjt_nm
																	  ,YM
																  from IRIS_NEW_PRDT_SAL_STAT
																 where 1=1
																 group by np_cd ,pjt_nm,YM) CNT ) YYCNT
														 WHERE 1=1
														   AND MST.PJT_NM=YYCNT.PJT_NM
														   AND MST.YM=YYCNT.YM) MST
										 WHERE 1=1
										GROUP BY  NP_CD) d
						on a.wbs_cd=d.np_cd
				where   1=1
				and     #{condYy} BETWEEN LEFT(a.TSS_STRT_DD, 4) AND LEFT(a.TSS_FNH_DD, 4)
				) m
		]]>
		WHERE  1=1
		and   (left(m.tssFnhDdArsl ,4) >= #{condYy} or m.tssFnhDdArsl is null)
		<if test="_roleId == 'WORK_IRI_T16' ">
			AND   deptName like '%'+#{_userDeptName}+'%'
		</if>
		order by m.deptName, m.prjNm
    </select>











    <select id="retrieveTechTeamTssStatDtlPopList" resultType="hashmap">
    <![CDATA[
        --retrieveTechTeamTssStatDtlPopList
		select np_cd as npCd
		      ,pjt_nm as nm
		      ,max(case when mm='01' then amt else 0 end) as m1
			  ,max(case when mm='02' then amt else 0 end) as m2
			  ,max(case when mm='03' then amt else 0 end) as m3
			  ,max(case when mm='04' then amt else 0 end) as m4
			  ,max(case when mm='05' then amt else 0 end) as m5
			  ,max(case when mm='06' then amt else 0 end) as m6
			  ,max(case when mm='07' then amt else 0 end) as m7
			  ,max(case when mm='08' then amt else 0 end) as m8
			  ,max(case when mm='09' then amt else 0 end) as m9
			  ,max(case when mm='10' then amt else 0 end) as m10
			  ,max(case when mm='11' then amt else 0 end) as m11
			  ,max(case when mm='12' then amt else 0 end) as m12
		  from (select np_cd
		              ,pjt_nm
					  ,right(ym,2) mm
					  ,round(sum(sal_sum_amt)/convert(float,100000000),2) as amt
				  from IRIS_NEW_PRDT_SAL_STAT
				 where 1=1
				   and left(ym,4)=#{yy}
				   and np_cd=#{npCd}
				 group by np_cd, pjt_nm ,right(ym,2)) main
		  group by np_cd ,pjt_nm
		]]>
    </select>

    <!-- 통계 >  프로젝트 리스트  -->
    <select id="retrievePrjRsstStatList" resultType="hashmap">
    <![CDATA[
        /* stat.prj.retrievePrjRsstStatList 년도별 프로젝트 통계 */
		select m.prjCd
		      ,m.deptNm
		      ,m.prjNm
			  ,m.plEmpName
			  ,m.prjCpsn
			  ,m.prptGoalCnt
			  ,m.prptArslCnt
			  ,m.ttm
			  ,m.tssBudg
			  ,m.tssExp
			  ,ROUND((CASE WHEN m.tssBudg != 0 AND m.tssBudg > 0 THEN (m.tssExp/ m.tssBudg) * 100 ELSE NULL END),1,1)  as tssExe    /* 집행율(%) 소수점1자리*/
			  ,m.pduGoalCnt
			  ,m.arslCnt
			  ,m.wbsCd
		from  (
				select a.prj_cd as prjCd
					  ,(select dept_name from IRIS_SSO_DEPT where dept_code = a.DEPT_UPER) as deptNm
					  ,a.prj_nm as prjNm
					  ,(select sa_name from  iris_sso_user where sa_sabun_new = a.PL_EMP_NO) as plEmpName
					  ,case when convert(nvarchar(4), getdate(), 23) = #{yyyy} then (select count(distinct b.TMMR_EMP_NO)
																				from   IRIS_PRJ_TMMR_INFO b
																				where  b.PRJ_CD = a.PRJ_CD
																				and   (b.patc_end_dt = '' or  b.patc_end_dt is null)
																			  )
						    else  (select count(distinct b.TMMR_EMP_NO)
								from   IRIS_PRJ_TMMR_INFO b
								where  b.PRJ_CD = a.PRJ_CD
								and   #{yyyy} between left(b.PATC_STR_DT, 4) and left((case when b.PATC_END_DT = '' or b.PATC_END_DT is null then '9999' else  b.PATC_END_DT end), 4)
								) end  as prjCpsn
					  ,round(isnull((
						SELECT (SUM(ISNULL(A1.m01,0)) + SUM(ISNULL(A1.m02,0)) + SUM(ISNULL(A1.m03,0)) + SUM(ISNULL(A1.m04,0)) + SUM(ISNULL(A1.m05,0)) + SUM(ISNULL(A1.m06,0))
											  + SUM(ISNULL(A1.m07,0)) + SUM(ISNULL(A1.m08,0)) + SUM(ISNULL(A1.m09,0)) + SUM(ISNULL(A1.m10,0)) + SUM(ISNULL(A1.m11,0)) + SUM(ISNULL(A1.m12,0))) as 'monthSum'
										  FROM (
						SELECT  [${yyyy}01] as m01, [${yyyy}02] as m02, [${yyyy}03] as m03, [${yyyy}04] as m04, [${yyyy}05] as m05,[${yyyy}06] as m06
								, [${yyyy}07] as m07 ,[${yyyy}08] as m08, [${yyyy}09] as m09, [${yyyy}10] as m10, [${yyyy}11] as m11,[${yyyy}12] as m12
							FROM (
								SELECT YY_MM, EXP_SCN_CD, PLN_EXP /*소수점2자리 반올림*/
									FROM IRIS_TSS_GEN_TRWI_BUDG_LIST  WITH (NOLOCK)
									WHERE TSS_CD IN ( SELECT M.TSS_CD FROM  IRIS_TSS_MGMT_MST M INNER JOIN IRIS_PRJ_RSST_MST P
														ON M.PRJ_CD = P.PRJ_CD
													WHERE P.PRJ_CD = a.PRJ_CD
													)
									AND    TSS_CD LIKE '%2'
									AND   YY_MM LIKE '%'+ #{yyyy}+'%'
								) AS z
							PIVOT ( SUM(PLN_EXP) FOR YY_MM IN ([${yyyy}01],[${yyyy}02],[${yyyy}03],[${yyyy}04],[${yyyy}05],[${yyyy}06]
															,[${yyyy}07],[${yyyy}08],[${yyyy}09],[${yyyy}10],[${yyyy}11],[${yyyy}12]) ) A
							) A1
						),0)/100,1,1) as tssBudg
						,ROUND(
										ISNULL((
											SELECT (ISNULL(SUM(X1.m01),0) + ISNULL(SUM(X1.m02),0) + ISNULL(SUM(X1.m03),0) + ISNULL(SUM(X1.m04),0) + ISNULL(SUM(X1.m05),0) + ISNULL(SUM(X1.m06),0) +
													ISNULL(SUM(X1.m07),0) + ISNULL(SUM(X1.m08),0) + ISNULL(SUM(X1.m09),0) + ISNULL(SUM(X1.m10),0) + ISNULL(SUM(X1.m11),0) + ISNULL(SUM(X1.m12),0) ) as yearSum
											  FROM (
													SELECT ISNULL([${yyyy}01],0) as m01, ISNULL([${yyyy}02],0) as m02, ISNULL([${yyyy}03],0) as m03, ISNULL([${yyyy}04],0) as m04, ISNULL([${yyyy}05],0) as m05,ISNULL([${yyyy}06],0) as m06
														 , ISNULL([${yyyy}07],0) as m07 ,ISNULL([${yyyy}08],0) as m08, ISNULL([${yyyy}09],0) as m09, ISNULL([${yyyy}10],0) as m10, ISNULL([${yyyy}11],0) as m11,ISNULL([${yyyy}12],0) as m12
													  FROM (
															SELECT YY_MM, EXP_SCN_CD,  ARSL_EXP /*소수점2자리 반올림*/
															  FROM IRIS_TSS_GEN_TRWI_BUDG_LIST  WITH (NOLOCK)
															 WHERE TSS_CD IN ( SELECT M.TSS_CD FROM  IRIS_TSS_MGMT_MST M INNER JOIN IRIS_PRJ_RSST_MST P
																				   ON M.PRJ_CD = P.PRJ_CD
																				WHERE P.PRJ_CD =  a.PRJ_CD
																			 )
																AND TSS_CD LIKE '%2'
																AND YY_MM LIKE '%'+ #{yyyy}+'%'
														   ) AS X
													 PIVOT ( SUM(ARSL_EXP) FOR YY_MM IN ([${yyyy}01],[${yyyy}02],[${yyyy}03],[${yyyy}04],[${yyyy}05],[${yyyy}06]
																					   ,[${yyyy}07],[${yyyy}08],[${yyyy}09],[${yyyy}10],[${yyyy}11],[${yyyy}12]) ) A
											) X1
							),0)/100,1,1)  as tssExp 		/* 과제 총 비용(억원)*/
							, ISNULL(b.PRPT_GOAL_CNT,0) AS prptGoalCnt
							, 0                         AS prptArslCnt  /*실적 지적재산권 개수*/

							, isnull( ( /*과제완료율 : 계획월수/실행월수 * 100 */
								SELECT Z.TTM
									FROM (
									SELECT Y.PRJ_CD
											, ROUND(
													( CASE WHEN SUM(Y.TSS_PLN_DIFF_MON) != 0 THEN (SUM(Y.TSS_PLN_DIFF_MON) / SUM(Y.TSS_CMPL_DIFF_MON)) * 100
															ELSE 0 END )
													,1,1) as TTM /*TTM(개발완료)*/
									FROM (
										SELECT (CASE WHEN CONVERT(DATETIME, X.TSS_FNH_DD) > CONVERT(DATETIME, X.TSS_STRT_DD)
												THEN ROUND(CONVERT(float,DATEDIFF (MONTH, CONVERT(DATETIME, X.TSS_STRT_DD) , CONVERT(DATETIME, X.TSS_FNH_DD) )),2,1) + 1
												ELSE 0 END)  as TSS_PLN_DIFF_MON /*과제계획월수(월단위로 일자 채워서 계산)*/
												, X.TSS_STRT_DD
												, X.TSS_FNH_DD
												, (CASE WHEN CONVERT(DATETIME, X.CMPL_B_FNH_DD) > CONVERT(DATETIME, X.CMPL_B_STRT_DD)
														THEN ROUND(CONVERT(float,DATEDIFF (MONTH, CONVERT(DATETIME, X.CMPL_B_STRT_DD) , CONVERT(DATETIME, X.CMPL_B_FNH_DD) )),2,1) + 1
														ELSE 0 END)  as TSS_CMPL_DIFF_MON /*과제실행월수(월단위로 일자 채워서 계산)*/
												, X.CMPL_B_STRT_DD
												, X.CMPL_B_FNH_DD
												, X.PRJ_CD
											FROM IRIS_TSS_MGMT_MST X
											WHERE X.PGS_STEP_CD = 'CM'
											AND  #{yyyy}  BETWEEN SUBSTRING(X.CMPL_B_STRT_DD,1,4) AND SUBSTRING(X.CMPL_B_FNH_DD,1,4)
											AND X.PRJ_CD = A.PRJ_CD
									) AS Y
									GROUP BY Y.PRJ_CD
								) AS Z
								), 0 ) as ttm 	/*TTM(과제완료율)*/
							  ,isnull((select isnull(sum(PDU_GOAL_CNT) , 0)
										from IRIS_PRJ_RSST_PDU
										where  prj_cd = a.PRJ_CD
										and    YLD_TYPE = '300'
										and    PDU_GOAL_YEAR = #{yyyy}
										) , 0 ) as pduGoalCnt  /*Monthly Report 목표개수*/
							   ,isnull((select isnull(sum(arsl_cnt) , 0)
										from IRIS_PRJ_RSST_PDU
										where  prj_cd = a.PRJ_CD
										and    YLD_TYPE = '300'
										and    left(arsl_year_mon, 4) = #{yyyy}
										) , 0 ) as arslCnt /*Monthly Report 실행개수*/
							   ,a.wbs_cd as wbsCd
				from   IRIS_PRJ_RSST_MST a
					   left outer join  (
										select  PRPT_GOAL_CNT , PRJ_CD, PRPT_GOAL_YEAR, FRNW_SCN
										from IRIS_PRJ_PTOT_PRPT

										)  b
						 on     b.prj_cd =a.prj_cd
						 and   b.PRPT_GOAL_YEAR = #{yyyy}
						 and   b.FRNW_SCN = '01'
				where  1=1
				and    a.PRJ_CD <> 'PRJ00004'
				and    #{yyyy} between left(a.PRJ_STR_DT, 4) and left((case when a.PRJ_END_DT = '' or a.PRJ_END_DT is null then '9999' else  a.PRJ_END_DT end), 4)

				) m
			where  1=1
			]]>

			<if test="_roleId == 'WORK_IRI_T16' ">
			AND    m.deptNm LIKE '%'+#{_userDeptName}+'%'
			</if>

			order by m.deptNm
    </select>

    <!-- 대외협력과제 년도별 통계 -->
    <select id="retrieveOusdTssStatList" resultType="hashmap">
    <![CDATA[
        /* stat.prj.retrieveOusdTssStatList 대외협력과제 년도별 통계 */
		WITH TSS_LIST AS (
		    SELECT Y.PK_WBS_CD    AS PK_WBS_CD
		         , Y.PGS_STEP_CD  AS PGS_STEP_CD
		         , Y.TSS_CD       AS TSS_CD
		         , Z.TSS_CD       AS PG_TSS_CD
		     FROM (SELECT PK_WBS_CD, TSS_CD, STEPRANK, PGS_STEP_CD
		                 , RANK() OVER (PARTITION BY X.PK_WBS_CD ORDER BY X.STEPRANK ASC, TSS_CD DESC) AS OVER_STEP_RANK
		             FROM (SELECT CASE WHEN PGS_STEP_CD = 'CM' OR PGS_STEP_CD = 'DC' THEN 1
		                             WHEN PGS_STEP_CD = 'PG' AND TSS_ST = '100' THEN 2
		                             WHEN PGS_STEP_CD = 'PG' AND (TSS_ST = '101' OR TSS_ST = '102') THEN 3
		                             WHEN PGS_STEP_CD = 'AL' THEN 4
		                             WHEN PGS_STEP_CD = 'PG' AND TSS_ST != '100' THEN 5
		                             WHEN PGS_STEP_CD = 'PL' THEN 6 END AS STEPRANK
		                         , TSS_CD, PGS_STEP_CD, TSS_ST, PK_WBS_CD
		                     FROM IRIS_TSS_MGMT_MST) X) Y
		         , IRIS_TSS_MGMT_MST Z
		     WHERE Y.PK_WBS_CD = Z.PK_WBS_CD
		       AND Y.OVER_STEP_RANK = 1
		       AND Z.PGS_STEP_CD = 'PG'
		       AND Z.TSS_SCN_CD = 'O'
		)
		SELECT AA.BIZ_DPT_CD   as bizDptCd   /*과제유형코드*/
		     , AA.BIZ_DPT_NM   as bizBptNm   /*과제유형명*/
		     , AA.DEPT_CODE    as deptCode   /*조직코드*/
			 , AA.DEPT_NAME    as deptName   /*조직명*/
			 , AA.PRJ_CD       as prjCd      /*프로젝트코드*/
			 , AA.PRJ_NM       as prjNm      /*프로젝트명*/
			 , AA.CNTT_TYPE_CD as cnttTypeCd /*계약유형코드*/
			 , AA.CNTT_TYPE_NM as cnttTypeNm /*계약유형명*/
			 , AA.TSS_CD       as tssCd      /*과제코드*/
			 , AA.TSS_NM       as tssNm      /*과제명*/
			 , AA.COO_INST_CD  as cooInstCd  /*협력기관코드*/
			 , AA.COO_INST_NM  as cooInstNm  /*협력기관명*/
			 , AA.SPLT_NM      as spltNm     /*협력기관연구책임자*/
			 , AA.TSS_STRT_DD  as tssStrtDd  /*과제시작일자*/
			 , AA.TSS_FNH_DD   as tssFnhDd   /*과제종료일자*/
			 , SUBSTRING(CONVERT(CHAR(8), CONVERT(DATETIME, AA.TSS_STRT_DD), 2),1,5) as strTssStrtDd /*화면표시용 과제시작일자*/
			 , SUBSTRING(CONVERT(CHAR(8), CONVERT(DATETIME, AA.TSS_FNH_DD), 2),1,5)  as strTssFnhDd  /*화면표시용 과제종료일자*/
			 --, ROUND(CONVERT(float,DATEDIFF (day, CONVERT(DATETIME, AA.TSS_STRT_DD) , CONVERT(DATETIME, AA.TSS_FNH_DD) )) / 31,2,1) as tssDiffMon /*과제소요월수(31일단위로 나눠서 소수점2자리표시)*/
			 , (CASE WHEN CONVERT(DATETIME, AA.TSS_FNH_DD) > CONVERT(DATETIME, AA.TSS_STRT_DD)
				     THEN ROUND(CONVERT(float,DATEDIFF (MONTH, CONVERT(DATETIME, AA.TSS_STRT_DD) , CONVERT(DATETIME, AA.TSS_FNH_DD) )),1,1)  + 1
				ELSE 0 END)  as tssDiffMon /*과제소요월수(월단위로 일자 채워서 계산)*/
			 , AA.WBS_CD       as wbsCd      /*(과제)WBS코드*/
			 , AA.RSST_EXP     as rsstExp    /*연구비(원)*/
			 , AA.RSST_EXP_MIL as rsstExpMil /*연구비(억원)*/
			 , AA.SA_SABUN_NEW as saSabunNew /*과제리더사번*/
			 , AA.SA_NAME      as saName     /*과제리더명*/
          FROM (
				SELECT B.BIZ_DPT_CD    /*과제유형코드*/
					 , (SELECT TOP 1 X.COM_DTL_NM FROM IRIS_ADM_COM_CD X WHERE X.COM_CD_CD = 'BIZ_DPT_CD' AND X.COM_DTL_CD = B.BIZ_DPT_CD) AS BIZ_DPT_NM /*과제유형명*/
					 , B.DEPT_CODE     /*조직코드*/
					 , CASE WHEN B.DEPT_NAME IS NULL OR B.DEPT_NAME ='' THEN dbo.fn_getDeptName(E.DEPT_UPER)
							WHEN B.DEPT_NAME IS NOT NULL OR B.DEPT_NAME !='' THEN B.DEPT_NAME END           		AS DEPT_NAME     --조직명
					 , B.PRJ_CD        /*프로젝트코드*/
					 , CASE WHEN B.PRJ_NM IS NULL OR B.PRJ_NM=''  THEN RIGHT(dbo.fn_getPrjName(B.PRJ_CD),LEN(dbo.fn_getPrjName(B.PRJ_CD))-CHARINDEX('.',dbo.fn_getPrjName(B.PRJ_CD) ))
							WHEN B.PRJ_NM IS NOT NULL OR B.PRJ_NM !='' THEN RIGHT(B.PRJ_NM,LEN(B.PRJ_NM)-CHARINDEX('.',B.PRJ_NM ))  END							AS PRJ_NM        --소속명(프로젝트명)
					 , C.CNTT_TYPE_CD /*계약유형코드*/
					 , (SELECT TOP 1 X.COM_DTL_NM FROM IRIS_ADM_COM_CD X WHERE X.COM_CD_CD = 'CNTT_TYPE_CD' AND X.COM_DTL_CD = C.CNTT_TYPE_CD) AS CNTT_TYPE_NM /*계약유형명*/
					 , B.TSS_CD
					 , B.TSS_NM
					 , B.COO_INST_CD   /*협력기관코드*/
					 , (SELECT TOP 1 X.INST_NM FROM IRIS_KNLD_OSCP_SPLT X WHERE X.DEL_YN = 'N' AND X.OSCP_SPLT_ID = B.COO_INST_CD ) AS COO_INST_NM /*협력기관명*/
					 , (SELECT TOP 1 X.SPLT_NM FROM IRIS_KNLD_OSCP_SPLT X WHERE X.DEL_YN = 'N' AND X.OSCP_SPLT_ID = B.COO_INST_CD ) AS SPLT_NM /*협력기관연구책임자*/
					 , (CASE WHEN A.PGS_STEP_CD = 'CM' THEN B.CMPL_B_STRT_DD WHEN A.PGS_STEP_CD = 'DC' THEN B.DCAC_B_STRT_DD ELSE B.TSS_STRT_DD END) AS TSS_STRT_DD /*과제시작일자*/
					 , (CASE WHEN A.PGS_STEP_CD = 'CM' THEN B.CMPL_B_FNH_DD  WHEN A.PGS_STEP_CD = 'DC' THEN B.DCAC_B_FNH_DD  ELSE B.TSS_FNH_DD END)  AS TSS_FNH_DD  /*과제종료일자*/
					 , B.WBS_CD /*WBS코드*/
					 , C.RSST_EXP /*연구비(원)*/
					 , (ISNULL(C.RSST_EXP,0) / 100000000) AS RSST_EXP_MIL /*연구비(억원)*/
					 , B.SA_SABUN_NEW /*과제리더사번*/
					 , ISNULL((SELECT TOP 1 X.SA_NAME FROM IRIS_SSO_USER X WHERE X.SA_SABUN_NEW = B.SA_SABUN_NEW AND X.SSO_EX_FLAG != 'D' AND X.SA_USER IS NOT NULL AND X.SA_USER != '' ),B.SA_SABUN_NAME) AS SA_NAME /*과제리더명*/
				  FROM TSS_LIST A
				 INNER JOIN IRIS_TSS_MGMT_MST B
					ON A.TSS_CD = B.TSS_CD
				 LEFT OUTER JOIN IRIS_PRJ_RSST_MST E
					ON B.PRJ_CD = E.PRJ_CD
				 INNER JOIN IRIS_TSS_OUSD_COO_SMRY C
					ON A.TSS_CD = C.TSS_CD
				 WHERE #{searchYyyy} BETWEEN  LEFT(B.TSS_STRT_DD, 4) AND  LEFT(B.TSS_FNH_DD, 4)
				   AND B.DEL_YN = 'N'
			) AA

		 WHERE   1=1
    ]]>
		 <if test="_roleId == 'WORK_IRI_T16' ">
		 	AND   AA.DEPT_NAME LIKE '%'+#{_userDeptName}+'%'
		 </if>
		 ORDER BY AA.BIZ_DPT_NM, AA.DEPT_NAME, AA.PRJ_NM
    </select>


    <!-- 국책과제 년도별 통계 -->
    <select id="retrieveNatTssStatList" resultType="hashmap">
    <![CDATA[
        --retrieveNatTssStatList 국책과제 년도별 통계
        WITH TSS_LIST AS (
            SELECT Y.PK_WBS_CD
                 , Y.TSS_CD
                 , Y.TSS_NOS_ST
                 , Y.PGS_STEP_CD
                 , Y.MAX_TSS_NOS_ST
                 , (SELECT A.TSS_CD FROM IRIS_TSS_MGMT_MST A WHERE A.PK_WBS_CD = Y.PK_WBS_CD AND A.TSS_NOS_ST = Y.TSS_NOS_ST AND A.PGS_STEP_CD = 'PG') AS PG_TSS_CD
              FROM (SELECT PK_WBS_CD, TSS_CD, STEPRANK, PGS_STEP_CD, TSS_NOS_ST
                         , RANK() OVER (PARTITION BY X.PK_WBS_CD, X.TSS_NOS_ST ORDER BY X.STEPRANK ASC, TSS_CD DESC) AS OVER_STEP_RANK
                         , MAX(TSS_NOS_ST) OVER (PARTITION BY X.PK_WBS_CD) AS MAX_TSS_NOS_ST
                     FROM (SELECT CASE WHEN PGS_STEP_CD = 'CM' OR PGS_STEP_CD = 'DC' THEN 1
                                     WHEN PGS_STEP_CD = 'PG' AND TSS_ST = '100' THEN 2
                                     WHEN PGS_STEP_CD = 'PG' AND (TSS_ST = '101' OR TSS_ST = '102') THEN 3
                                     WHEN PGS_STEP_CD = 'AL' THEN 4
                                     WHEN PGS_STEP_CD = 'PG' AND TSS_ST != '100' THEN 5
                                     WHEN PGS_STEP_CD = 'PL' THEN 6 END AS STEPRANK
                                 , TSS_CD, PGS_STEP_CD, TSS_ST, PK_WBS_CD, TSS_NOS_ST
                             FROM IRIS_TSS_MGMT_MST WHERE TSS_SCN_CD = 'N') X) Y
             WHERE 1 = 1
               AND Y.OVER_STEP_RANK = 1
               AND Y.TSS_NOS_ST = Y.MAX_TSS_NOS_ST
        )
        SELECT *
		FROM  (
		        SELECT B.WBS_CD                                                                 AS wbsCd        --과제번호
		             , B.TSS_CD                                                                 AS tssCd        --과제코드
					 , CASE WHEN B.DEPT_NAME IS NULL OR B.DEPT_NAME ='' THEN dbo.fn_getDeptName(E.DEPT_UPER)
							WHEN B.DEPT_NAME IS NOT NULL OR B.DEPT_NAME !='' THEN B.DEPT_NAME END           		AS deptName     --조직명
					 , CASE WHEN B.PRJ_NM IS NULL OR B.PRJ_NM=''  THEN RIGHT(dbo.fn_getPrjName(B.PRJ_CD),LEN(dbo.fn_getPrjName(B.PRJ_CD))-CHARINDEX('.',dbo.fn_getPrjName(B.PRJ_CD) ))
							WHEN B.PRJ_NM IS NOT NULL OR B.PRJ_NM !='' THEN RIGHT(B.PRJ_NM,LEN(B.PRJ_NM)-CHARINDEX('.',B.PRJ_NM ))  END							AS prjNm        --소속명(프로젝트명)
		             , B.BIZ_NM                                                                 AS bizNm        --사업명
		             , B.SUPV_OPS_NM                                                            AS supvOpsNm    --주관부처
		             , B.TSS_NM                                                                 AS tssNm        --과제명
		             , ''                                                               AS tssSmryTxt   --과제개요
					 , ISNULL(dbo.fn_getNameOnTssPgsStep(B.TSS_CD, 'USER', B.SA_SABUN_NEW) , B.SA_SABUN_NAME) AS saUserName --과제리더명
		             , D.TTL_CRRO_STRT_DT                                                       AS tssStrtDd    --과제시작일
		             , D.TTL_CRRO_FNH_DT                                                        AS tssFnhDdPln  --과제종료일-계획
		             , CASE WHEN B.PGS_STEP_CD = 'DC' THEN B.DCAC_B_FNH_DD
		                    WHEN B.PGS_STEP_CD = 'CM' THEN B.CMPL_B_FNH_DD END                  AS tssFnhDdArsl --과제종료일-실적
		             , CASE WHEN B.PGS_STEP_CD = 'DC' THEN B.DCAC_NX_FNH_DD
		                    WHEN B.PGS_STEP_CD = 'CM' THEN B.CMPL_NX_FNH_DD END                 AS tssFnhDdStoa --과제종료일-정산
		             , DATEDIFF(MM, D.TTL_CRRO_STRT_DT, D.TTL_CRRO_FNH_DT)+1                    AS wnedTrmPln   --소요기간-계획
		             , CASE WHEN B.PGS_STEP_CD = 'DC'
		                    THEN DATEDIFF(MM, D.TTL_CRRO_STRT_DT, B.DCAC_B_FNH_DD)+1
		                    WHEN B.PGS_STEP_CD = 'CM'
		                    THEN DATEDIFF(MM, D.TTL_CRRO_STRT_DT, B.CMPL_B_FNH_DD)+1 END        AS wnedTrmArsl  --소요기간-실적
		             , CASE WHEN B.PGS_STEP_CD = 'DC'
		                    THEN DATEDIFF(MM, D.TTL_CRRO_STRT_DT, B.DCAC_NX_FNH_DD)+1
		                    WHEN B.PGS_STEP_CD = 'CM'
		                    THEN DATEDIFF(MM, D.TTL_CRRO_STRT_DT, B.CMPL_NX_FNH_DD)+1 END       AS wnedTrmStoa  --소요기간-정산
		             , B.TSS_NOS_ST+'차년도'                                                    AS tssNosSt
		             , dbo.fn_getComDtlNm('PGS_STEP_CD',B.PGS_STEP_CD)                          AS pgsStepNm    --진행상태
		             , dbo.fn_getComDtlNm('TSS_ST',B.TSS_ST)                                    AS tssStNm      --상태
		             , C.gvmCash1
		             , C.gvmAthg1
		             , C.prvCash1
		             , C.prvAthg1
		             , C.gvmCash2
		             , C.gvmAthg2
		             , C.prvCash2
		             , C.prvAthg2
		             , C.gvmCash3
		             , C.gvmAthg3
		             , C.prvCash3
		             , C.prvAthg3
		             , C.gvmCash4
		             , C.gvmAthg4
		             , C.prvCash4
		             , C.prvAthg4
		             , C.gvmCash5
		             , C.gvmAthg5
		             , C.prvCash5
		             , C.prvAthg5
		             , C.gvmCash1 + C.gvmCash2 + C.gvmCash3 + C.gvmCash4 + C.gvmCash5 AS gvmCashSum
		             , C.gvmAthg1 + C.gvmAthg2 + C.gvmAthg3 + C.gvmAthg4 + C.gvmAthg5 AS gvmAthgSum
		             , C.prvCash1 + C.prvCash2 + C.prvCash3 + C.prvCash4 + C.prvCash5 AS prvCashSum
		             , C.prvAthg1 + C.prvAthg2 + C.prvAthg3 + C.prvAthg4 + C.prvAthg5 AS prvAthgSum
		          FROM TSS_LIST A
		         INNER JOIN IRIS_TSS_MGMT_MST B
		            ON A.TSS_CD = B.TSS_CD
				 LEFT OUTER JOIN IRIS_PRJ_RSST_MST E
					ON B.PRJ_CD = E.PRJ_CD
		         INNER JOIN IRIS_TSS_NAT_PLCY_SMRY D
		            ON A.TSS_CD = D.TSS_CD
		          LEFT JOIN (SELECT TSS_CD
		          	, SUM(CASE WHEN BIZ_EXP_CD = 'aa' THEN ISNULL(YY_NOS_CASH1, 0) ELSE 0 END) AS gvmCash1
					, SUM(CASE WHEN BIZ_EXP_CD = 'aa' THEN ISNULL(YY_NOS_ATHG1, 0) ELSE 0 END) AS gvmAthg1
					, SUM(CASE WHEN BIZ_EXP_CD = 'ab' THEN ISNULL(YY_NOS_CASH1, 0) ELSE 0 END) AS prvCash1
					, SUM(CASE WHEN BIZ_EXP_CD = 'ab' THEN ISNULL(YY_NOS_ATHG1, 0) ELSE 0 END) AS prvAthg1
					, SUM(CASE WHEN BIZ_EXP_CD = 'aa' THEN ISNULL(YY_NOS_CASH2, 0) ELSE 0 END) AS gvmCash2
					, SUM(CASE WHEN BIZ_EXP_CD = 'aa' THEN ISNULL(YY_NOS_ATHG2, 0) ELSE 0 END) AS gvmAthg2
					, SUM(CASE WHEN BIZ_EXP_CD = 'ab' THEN ISNULL(YY_NOS_CASH2, 0) ELSE 0 END) AS prvCash2
					, SUM(CASE WHEN BIZ_EXP_CD = 'ab' THEN ISNULL(YY_NOS_ATHG2, 0) ELSE 0 END) AS prvAthg2
					, SUM(CASE WHEN BIZ_EXP_CD = 'aa' THEN ISNULL(YY_NOS_CASH3, 0) ELSE 0 END) AS gvmCash3
					, SUM(CASE WHEN BIZ_EXP_CD = 'aa' THEN ISNULL(YY_NOS_ATHG3, 0) ELSE 0 END) AS gvmAthg3
					, SUM(CASE WHEN BIZ_EXP_CD = 'ab' THEN ISNULL(YY_NOS_CASH3, 0) ELSE 0 END) AS prvCash3
					, SUM(CASE WHEN BIZ_EXP_CD = 'ab' THEN ISNULL(YY_NOS_ATHG3, 0) ELSE 0 END) AS prvAthg3
					, SUM(CASE WHEN BIZ_EXP_CD = 'aa' THEN ISNULL(YY_NOS_CASH4, 0) ELSE 0 END) AS gvmCash4
					, SUM(CASE WHEN BIZ_EXP_CD = 'aa' THEN ISNULL(YY_NOS_ATHG4, 0) ELSE 0 END) AS gvmAthg4
					, SUM(CASE WHEN BIZ_EXP_CD = 'ab' THEN ISNULL(YY_NOS_CASH4, 0) ELSE 0 END) AS prvCash4
					, SUM(CASE WHEN BIZ_EXP_CD = 'ab' THEN ISNULL(YY_NOS_ATHG4, 0) ELSE 0 END) AS prvAthg4
					, SUM(CASE WHEN BIZ_EXP_CD = 'aa' THEN ISNULL(YY_NOS_CASH5, 0) ELSE 0 END) AS gvmCash5
					, SUM(CASE WHEN BIZ_EXP_CD = 'aa' THEN ISNULL(YY_NOS_ATHG5, 0) ELSE 0 END) AS gvmAthg5
					, SUM(CASE WHEN BIZ_EXP_CD = 'ab' THEN ISNULL(YY_NOS_CASH5, 0) ELSE 0 END) AS prvCash5
					, SUM(CASE WHEN BIZ_EXP_CD = 'ab' THEN ISNULL(YY_NOS_ATHG5, 0) ELSE 0 END) AS prvAthg5
		                       FROM IRIS_TSS_NAT_PLCY_BIZ_EXP
		                      GROUP BY TSS_CD) C
		            ON C.TSS_CD = ISNULL(A.TSS_CD, A.PG_TSS_CD)
		    ]]>
		        <if test="condYy != null and !condYy.equals('')">
		         WHERE #{condYy}  BETWEEN  LEFT(B.TSS_STRT_DD, 4) AND  LEFT(B.TSS_FNH_DD, 4)
		        </if>
		        ) a
		       where  1=1
		       	<if test="_roleId == 'WORK_IRI_T16' ">
				 AND    deptName LIKE '%'+#{_userDeptName}+'%'
		    	</if>
		       ORDER BY a.wbsCd, a.tssNosSt

    </select>
</mapper>