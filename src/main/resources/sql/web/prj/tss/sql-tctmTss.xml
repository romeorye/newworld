<?xml version="1.0" encoding="EUC-KR"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="prj.tss.tctm">
    <!--기술팀 과제 목록 조회-->
    <select id="selectList" resultType="hashmap">
        <![CDATA[
/*selectList 기술팀 과제 목록 조회*/
        select  distinct  z.wbs_cd                                                      as wbsCd
                ,z.wbs_cd                                                      as wbsCd2
                ,z.PK_WBS_CD                                                 as pkWbsCd
                ,z.tss_cd as tssCd
                ,case when z.PGS_STEP_CD = 'AL' then Z.al_TSS_NM
                      else z.TSS_NM end                                     as tssNm
                ,case when z.PGS_STEP_CD = 'AL' then Z.al_prj_NM
                      else z.prj_NM end                                     as prjNm
                ,case when z.PGS_STEP_CD = 'AL' then Z.al_dept_nm
                      else z.dept_nm end                                     as deptName
                ,case when z.PGS_STEP_CD = 'AL' then Z.al_TSS_STRT_DD
                      else z.TSS_STRT_DD end                                 as tssStrtDd
                ,case when z.PGS_STEP_CD = 'AL' then Z.al_TSS_FNH_DD
                      else z.TSS_FNH_DD end                                 as tssFnhDd
                ,CASE WHEN Z.PGS_STEP_CD = 'DC' THEN Z.DCAC_B_STRT_DD
                      WHEN Z.PGS_STEP_CD = 'CM' THEN Z.CMPL_B_STRT_DD END  AS cmplNxStrtDd --과제실적시작
                ,CASE WHEN Z.PGS_STEP_CD = 'DC' THEN Z.DCAC_B_FNH_DD
                      WHEN Z.PGS_STEP_CD = 'CM' THEN Z.CMPL_B_FNH_DD END      AS cmplNxFnhDd  --과제실적종료
                ,Z.TSS_ST                                                  AS tssSt        --상태
                ,dbo.fn_getComDtlNm('TSS_ST', Z.TSS_ST)                    AS tssStNm      --상태명
                ,dbo.fn_getTssStepNm(z.tss_cd) as tssStepNm
                ,dbo.fn_getGrsStepNm(z.tss_cd,'1') as grsStepNm
                ,dbo.fn_getQgateStepNm(z.wbs_cd,'0') as qgateStepNm
                ,Z.FRST_RGST_DT
                ,CASE WHEN Z.PGS_STEP_CD = 'AL' THEN Z.AL_SA_SABUN_NAME
                       ELSE Z.SA_SABUN_NAME END                             AS saUserName   --과제리더명
                ,Z.PGS_STEP_CD                                             AS pgsStepCd    --진행상태코드(PL:계획, PG:진행, CM:완료, AL: 변경, DC:중단)
                ,dbo.fn_getComDtlNm('PGS_STEP_CD',Z.PGS_STEP_CD)           AS pgsStepNm    --진행상태명
                ,Z.TSS_NOS_ST                                              AS tssNosSt     --과제차수상태코드(1차년도, 2 차년도, 3 차년도, 4차년도, 5차년도:국책과제)
                ,dbo.fn_getComDtlNm('TSS_NOS_ST',Z.TSS_NOS_ST)             AS tssNosStNm   --과제차수상태명
                ,Z.GRS_EV_ST                                               AS grsEvSt      --GRS상태
                ,Z.MY_TSS                                                  AS myTss
                ,Z.PROGRESSRATEREAL                                        AS progressrateReal
                ,Z.PROGRESSRATE                                            AS progressrate
                ,Z.PRJ_CD                                                  AS prjCd
                ,dbo.fn_getComDtlNm('TSS_TYPE',z.tss_type)                 AS tssTypeNm
                ,dbo.FN_ISEMPTY(z.ANCP_OT_PLN_DT, z.CTY_OT_PLN_M)          AS ctyOtPlnM
        from  (
                select   m.PRJ_CD
                        ,substring(m.prj_nm, CHARINDEX ('.', m.prj_nm) +1, len(m.prj_nm)  ) as prj_nm
                        ,substring(m.al_prj_nm, CHARINDEX ('.', m.al_prj_nm) +1, len(m.al_prj_nm)  ) as al_prj_nm
                        ,m.TSS_CD
                        ,m.PGS_STEP_CD
                        ,m.TSS_SCN_CD
                        ,m.WBS_CD
                        ,m.PK_WBS_CD
                        ,m.dept_nm
                        ,m.al_dept_nm
                        ,m.biz_dpt_cd
                        ,m.tss_nm
                        ,m.sa_sabun_name
                        ,m.al_sa_sabun_name
                        ,m.TSS_STRT_DD
                        ,m.TSS_FNH_DD
                        ,m.ALTR_B_STRT_DD
                        ,m.ALTR_B_FNH_DD
                        ,m.ALTR_NX_STRT_DD
                        ,m.ALTR_NX_FNH_DD
                        ,m.CMPL_B_STRT_DD
                        ,m.CMPL_B_FNH_DD
                        ,m.CMPL_NX_STRT_DD
                        ,m.CMPL_NX_FNH_DD
                        ,m.DCAC_B_STRT_DD
                        ,m.DCAC_B_FNH_DD
                        ,m.DCAC_NX_STRT_DD
                        ,m.DCAC_NX_FNH_DD
                        ,m.TSS_ST
                        ,m.TSS_NOS_ST
                        ,m.FRST_RGST_DT
                        ,m.FRST_RGST_ID
                        ,m.LAST_MDFY_DT
                        ,m.LAST_MDFY_ID
                        ,m.sa_sabun_new
                        ,m.al_tss_nm
                        ,m.al_TSS_STRT_DD
                        ,m.al_TSS_FNH_DD
                        ,m.TSS_TYPE
                        ,CTY_OT_PLN_M, ANCP_OT_PLN_DT
                        ,(SELECT TOP 1 X.GRS_EV_ST FROM IRIS_GRS_EV_RSLT_RGST X WHERE X.TSS_CD = M.TSS_CD ORDER BY X.TSS_CD_SN DESC) AS GRS_EV_ST
                        ,CASE WHEN  M.TSS_CD IN (SELECT X.TSS_CD FROM IRIS_TSS_PTC_RSST_MBR X WHERE X.SA_SABUN_NEW =  #{_userSabun})  THEN 'Y'
                                 when  isnull(m.al_sa_sabun_name, m.sa_sabun_name)  = #{_userNm} then 'Y'
                              ELSE 'N' END AS MY_TSS
                        ,'0.1'+'/'+'0.2' AS PROGRESSRATEREAL --진척율
                        -- 실적(WBS) /목표 -신호등
                        ,'0.2'+'/'+'0.4' AS PROGRESSRATE --진척(신호등)
                        ,CASE WHEN SUBSTRING(M.PK_WBS_CD, 1, 1) = 'D' THEN 1 ELSE 2 END AS R_NUM
                from   (
                       select  a.PRJ_CD
                              ,dbo.FN_isEmpty(a.PRJ_NM, dbo.fn_getPrjName(a.PRJ_CD)) as prj_nm
                              ,a.TSS_CD
                              ,a.PGS_STEP_CD
                              ,a.TSS_SCN_CD
                              ,a.WBS_CD
                              ,a.PK_WBS_CD
                              ,isnull(a.dept_name, dbo.fn_getUpperDeptNm(a.dept_code)) as dept_nm
                              ,isnull(b.dept_name, dbo.fn_getUpperDeptNm(b.dept_code)) as al_dept_nm
                              ,a.biz_dpt_cd
                              ,a.tss_nm
                              ,isnull(dbo.fn_getSabunName(a.sa_sabun_new), a.sa_sabun_name) as sa_sabun_name
                              ,isnull(dbo.fn_getSabunName(b.sa_sabun_new), b.sa_sabun_name) as al_sa_sabun_name
                              ,a.TSS_STRT_DD
                              ,a.TSS_FNH_DD
                              ,a.ALTR_B_STRT_DD
                              ,a.ALTR_B_FNH_DD
                              ,a.ALTR_NX_STRT_DD
                              ,a.ALTR_NX_FNH_DD
                              ,a.CMPL_B_STRT_DD
                              ,a.CMPL_B_FNH_DD
                              ,a.CMPL_NX_STRT_DD
                              ,a.CMPL_NX_FNH_DD
                              ,a.DCAC_B_STRT_DD
                              ,a.DCAC_B_FNH_DD
                              ,a.DCAC_NX_STRT_DD
                              ,a.DCAC_NX_FNH_DD
                              ,a.TSS_ST
                              ,a.TSS_NOS_ST
                              ,a.FRST_RGST_DT
                              ,a.FRST_RGST_ID
                              ,a.LAST_MDFY_DT
                              ,a.LAST_MDFY_ID
                              ,a.sa_sabun_new
                              ,b.tss_nm as al_tss_nm
                              ,isnull(b.PRJ_NM, dbo.fn_getPrjName(b.PRJ_CD)) as al_prj_nm
                              ,b.TSS_STRT_DD as al_TSS_STRT_DD
                              ,b.TSS_FNH_DD as al_TSS_FNH_DD
                              ,a.TSS_TYPE
                        from   IRIS_TSS_MGMT_MST a
                               LEFT JOIN (SELECT PK_WBS_CD, WBS_CD, TSS_STRT_DD, TSS_FNH_DD, TSS_NM, PRJ_CD, DEPT_CODE, DEPT_NAME, TSS_CD, SA_SABUN_NAME, SA_SABUN_NEW, prj_nm
                                          FROM IRIS_TSS_MGMT_MST
                                          WHERE PGS_STEP_CD = 'PG'
                                          AND TSS_SCN_CD = 'D'
                                         ) B
                               on a.PK_WBS_CD = B.PK_WBS_CD
                        where  a.DEL_YN ='N'
                        and    a.TSS_SCN_CD = 'D'
                        and    a.TSS_CD IN (SELECT TSS_CD
                                            FROM (SELECT PK_WBS_CD, TSS_CD, STEPRANK
                                                       , RANK() OVER (PARTITION BY X.PK_WBS_CD ORDER BY X.STEPRANK ASC, TSS_CD DESC) AS OVER_STEP_RANK
                                                  FROM (SELECT CASE WHEN PGS_STEP_CD = 'CM' OR PGS_STEP_CD = 'DC' THEN 1
                                                                    WHEN PGS_STEP_CD = 'PG' AND TSS_ST = '100' THEN 2
                                                                    WHEN PGS_STEP_CD = 'PG' AND (TSS_ST = '101' OR TSS_ST = '102' OR TSS_ST = '301' OR TSS_ST = '302') THEN 3
                                                                    WHEN PGS_STEP_CD = 'AL' THEN 4
                                                                    WHEN PGS_STEP_CD = 'PG' AND TSS_ST != '100' THEN 5
                                                                    WHEN PGS_STEP_CD = 'PL' THEN 6 END AS STEPRANK
                                                               , TSS_CD, PGS_STEP_CD, TSS_ST, PK_WBS_CD
                                                         FROM IRIS_TSS_MGMT_MST
                                                         where tss_scn_cd ='D' ) X) Y
                                                  WHERE OVER_STEP_RANK = 1
                                                  )
                        ) m
                      LEFT OUTER JOIN
                      (SELECT * FROM
                      (SELECT DISTINCT TSS_CD, GRS_EV_ST, DROP_YN FROM IRIS_GRS_EV_RSLT_RGST) t) g
                        ON m.TSS_CD = g.TSS_CD
                      LEFT OUTER JOIN IRIS_TSS_TCTM_SMRY s /*과제 기술팀과제 개요*/ ON (s.tss_cd = m.tss_cd)
                      WHERE  iif(g.DROP_YN is null or g.DROP_YN='','N',g.DROP_YN) = 'N' OR (g.DROP_YN='Y' AND g.GRS_EV_ST!='G1')
                ) z
        where  1=1
        ]]>
        <if test="tssRoleType.equals('S2')">
            and  ( z.wbs_cd in (select distinct wbs_cd
            from   IRIS_TSS_MGMT_MST a
            where   del_yn ='N'
            and     tss_cd in (
            select tss_cd
            from  IRIS_TSS_PTC_RSST_MBR
            where  1=1
            and    sa_sabun_new = #{_userSabun}
            )
            and   tss_scn_cd = 'D'

            union
            select  distinct wbs_cd
            from    IRIS_TSS_MGMT_MST a
            where      del_yn ='N'
            and     tss_scn_cd ='D'
            and     sa_sabun_new = #{_userSabun}

            union

             select distinct wbs_cd
             from   IRIS_TSS_MGMT_MST
             where  prj_cd = (
                             select prj_cd
                             from iris_prj_rsst_mst
                             where  DEPT_CD = (
                                                select  sa_dept_new
                                                from iris_sso_user
                                                where sa_sabun_new = #{_userSabun}
                                                )
                            )
            )
            or  Z.PRJ_CD in (select prj_cd  from iris_prj_rsst_mst where  pl_emp_no = #{_userSabun})

            )
        </if>

        <if test="tssRoleType.equals('S3')">
            AND z.BIZ_DPT_CD IN
            <foreach collection="tssRoleCd" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>

        <if test="wbsCd != null and !wbsCd.equals('')">
            AND (z.WBS_CD LIKE '%'+#{wbsCd}+'%'
            OR z.PGS_STEP_CD = CASE WHEN #{wbsCd} = 'SEED' THEN 'PL' ELSE 'X' END)
        </if>

        <if test="tssNm != null and !tssNm.equals('')">
            AND z.TSS_NM LIKE '%'+#{tssNm}+'%'
        </if>

        <if test="deptName != null and !deptName.equals('')">
            AND (z.dept_nm  LIKE '%'+#{deptName}+'%'  OR z.al_dept_nm LIKE '%'+#{deptName}+'%')
        </if>
        <if test="tssStrtDd != null and !tssStrtDd.equals('')">
            <![CDATA[
            AND convert(nvarchar(10), z.TSS_STRT_DD ) >= #{tssStrtDd}
        ]]>
        </if>
        <if test="tssFnhDd != null and !tssFnhDd.equals('')">
            <![CDATA[
            AND convert(nvarchar(10), z.TSS_FNH_DD ) <= #{tssFnhDd}
        ]]>
        </if>
        <if test="saUserName != null and !saUserName.equals('')">
            AND (z.SA_SABUN_NAME  LIKE '%'+#{saUserName}+'%'  OR  z.AL_SA_SABUN_NAME LIKE '%'+#{saUserName}+'%')
        </if>
        <if test="tssSt != null and !tssSt.equals('')">
            AND z.TSS_ST = #{tssSt}
        </if>
        <if test="pgsStepCd != null and !pgsStepCd.equals('')">
            AND z.PGS_STEP_CD = #{pgsStepCd} --진행상태코드(PL:계획, PG:진행, CM:완료, AL: 변경, DC:중단)
        </if>
        <if test="prjNm != null and !prjNm.equals('')">
            AND Z.PRJ_NM LIKE '%'+#{prjNm}+'%'
        </if>
        <if test="_roleId == 'WORK_IRI_T16' ">
            AND (z.dept_nm  LIKE '%'+#{deptName}+'%'  OR z.al_dept_nm LIKE '%'+#{deptName}+'%')
        </if>

        /*order by     z.TSS_STRT_DD  desc, z.TSS_FNH_DD desc, z.FRST_RGST_DT desc*/
        order by z.FRST_RGST_DT desc

    </select>

   <select id="selectNewTssCd" resultType="String">
   <![CDATA[
/*selectNewTssCd TSS CD 생성*/
            SELECT CASE WHEN #{createMod} = 'Altr' THEN #{pkWbsCd} ELSE #{wbsCd} END
                     + REPLICATE('0', 4 - LEN(COUNT(X.TSS_CD)+1)) + CAST(COUNT(X.TSS_CD) + 1 AS NVARCHAR(4))
              FROM IRIS_TSS_MGMT_MST X
             WHERE X.WBS_CD = #{wbsCd}
      ]]>
   </select>


    <!--기술팀 과제 상세 조회 -->
    <select id="selectInfo" resultType="hashmap">
    <![CDATA[
    /*selectInfo 기술팀 과제 상세 조회*/
            SELECT A.PRJ_CD          AS prjCd        --프로젝트코드
             --, B.PRJ_NM          AS prjNm        --프로젝트명
             , ISNULL(dbo.fn_getNameOnTssPgsStep(A.TSS_CD, 'PRJ', A.PRJ_CD), A.PRJ_NM) AS prjNm        --프로젝트명
             , A.TSS_CD          AS tssCd        --과제코드
             , A.PGS_STEP_CD     AS pgsStepCd    --진행단계코드
             , A.TSS_SCN_CD      AS tssScnCd     --과제구분코드
             , A.WBS_CD          AS wbsCd        --WBS코드
             , A.WBS_CD          AS orgWbsCd     --원본WBS코드
             , A.TSS_NM+' ('+ A.WBS_CD + ')'  AS wbsNm
               , A.PK_WBS_CD       AS pkWbsCd      --WBS코드
             , A.DEPT_CODE       AS deptCode     --조직코드(소속)
             , A.PPSL_MBD_CD     AS ppslMbdCd    --발의주체코드
             , A.BIZ_DPT_CD      AS bizDptCd     --사업부문코드
             , A.TSS_NM          AS tssNm        --과제명
             , A.SA_SABUN_NEW    AS saSabunNew   --과제리더사번
             , A.TSS_ATTR_CD     AS tssAttrCd    --과제속성코드
             , A.TSS_STRT_DD     AS tssStrtDd    --과제시작일
             , A.TSS_FNH_DD      AS tssFnhDd     --과제종료일
             , A.CUST_SQLT      AS custSqlt     --고객특성
             , A.TSS_SMRY_TXT      AS tssSmryTxt     --Concept
             , A.ALTR_B_STRT_DD  AS altrBStrtDd  --변경전시작일
             , A.ALTR_B_FNH_DD   AS altrBFnhDd   --변경전종료일
             , A.ALTR_NX_STRT_DD AS altrNxStrtDd --변경후시작일
             , A.ALTR_NX_FNH_DD  AS altrNxFnhDd  --변경후종료일
             , A.CMPL_B_STRT_DD  AS cmplBStrtDd  --완료전시작일
             , A.CMPL_B_FNH_DD   AS cmplBFnhDd   --완료전종료일
             , A.CMPL_NX_STRT_DD AS cmplNxStrtDd --완료후시작일
             , A.CMPL_NX_FNH_DD  AS cmplNxFnhDd  --완료후종료일
             , A.DCAC_B_STRT_DD  AS dcacBStrtDd  --중단전시작일
             , A.DCAC_B_FNH_DD   AS dcacBFnhDd   --중단전종료일
             , A.DCAC_NX_STRT_DD AS dcacNxStrtDd --중단후시작일
             , A.DCAC_NX_FNH_DD  AS dcacNxFnhDd  --중단후종료일
             , A.COO_INST_CD     AS cooInstCd    --협력기관코드
             , A.SUPV_OPS_NM     AS supvOpsNm    --주관부서명
             , A.EXRS_INST_NM    AS exrsInstNm   --전담기관명
             , A.BIZ_NM          AS bizNm        --사업명
             , A.TSS_ST          AS tssSt        --과제상태
             , A.TSS_NOS_ST      AS tssNosSt     --과제차수상태
             , A.TSS_ST_TXT      AS tssStTxt     --과제상태의견
             , A.PROD_G          AS prodG
             , ISNULL(dbo.fn_getNameOnTssPgsStep(A.TSS_CD, 'USER', A.SA_SABUN_NEW) , A.SA_SABUN_NAME) AS saSabunName --과제리더명
             , ISNULL(dbo.fn_getUpperDeptNm(A.DEPT_CODE)    , A.DEPT_NAME)     AS deptName   --조직(소속)명
             , dbo.fn_getComDtlNm('PGS_STEP_CD', A.PGS_STEP_CD) AS pgsStepNm  --진행단계명
             , dbo.fn_getComDtlNm('PPSL_MBD_CD', A.PPSL_MBD_CD) AS ppslMbdNm  --발의주체명
             , dbo.fn_getComDtlNm('BIZ_DPT_CD', A.BIZ_DPT_CD)   AS bizDptNm   --사업부문명
             , dbo.fn_getComDtlNm('TSS_ATTR_CD', A.TSS_ATTR_CD) AS tssAttrNm  --과제속성명
             , dbo.fn_getComDtlNm('PROD_G', A.PROD_G) AS prodGNm
             , dbo.fn_getComDtlNm('RSST_SPHE', A.RSST_SPHE) AS rsstSpheNm
             , dbo.fn_getComDtlNm('TSS_TYPE', A.TSS_TYPE)   AS tssTypeNm
             , A.RSST_SPHE                                      AS rsstSphe
             , A.TSS_TYPE                                       AS tssType
             , ( CASE WHEN A.TSS_SCN_CD = 'N'
                      THEN (SELECT X.TSS_CD FROM IRIS_TSS_MGMT_MST X WHERE X.PK_WBS_CD = A.PK_WBS_CD AND X.PGS_STEP_CD = 'PG' AND X.TSS_NOS_ST = A.TSS_NOS_ST)
                      ELSE  (SELECT X.TSS_CD FROM IRIS_TSS_MGMT_MST X WHERE X.PK_WBS_CD = A.PK_WBS_CD AND X.PGS_STEP_CD = 'PG')
                 END ) AS pgTssCd --진행과제코드
             , ( CASE WHEN A.TSS_SCN_CD = 'N'
                      THEN (SELECT X.TSS_ST FROM IRIS_TSS_MGMT_MST X WHERE X.PK_WBS_CD = A.PK_WBS_CD AND X.PGS_STEP_CD = 'PG' AND X.TSS_NOS_ST = A.TSS_NOS_ST)
                      ELSE  (SELECT X.TSS_ST FROM IRIS_TSS_MGMT_MST X WHERE X.PK_WBS_CD = A.PK_WBS_CD AND X.PGS_STEP_CD = 'PG')
                 END ) AS pgTssSt --진행과제상태코드
             , ( CASE WHEN A.TSS_SCN_CD = 'N'
                      THEN (SELECT X.SA_SABUN_NEW FROM IRIS_TSS_MGMT_MST X WHERE X.PK_WBS_CD = A.PK_WBS_CD AND X.PGS_STEP_CD = 'PG' AND X.TSS_NOS_ST = A.TSS_NOS_ST)
                      ELSE  (SELECT X.SA_SABUN_NEW FROM IRIS_TSS_MGMT_MST X WHERE X.PK_WBS_CD = A.PK_WBS_CD AND X.PGS_STEP_CD = 'PG')
                 END ) AS pgSaSabunNew --진행단계리더
             , (SELECT INST_NM + ' / ' +  OPS_NM  + ' / ' +  SPLT_NM+ ' '+ POA_NM FROM IRIS_KNLD_OSCP_SPLT WHERE DEL_YN = 'N' AND OSCP_SPLT_ID = A.COO_INST_CD ) AS cooInstNm --협력기관명
             , DATEDIFF ( month , CONVERT(DATE, A.TSS_STRT_DD) , CONVERT(DATE, A.TSS_FNH_DD) )  AS ttsDifMonth -- 과제소요기간
             , (SELECT TOP 1 X.GRS_EV_ST FROM IRIS_GRS_EV_RSLT_RGST X WHERE X.TSS_CD = A.TSS_CD ORDER BY X.TSS_CD_SN DESC) AS grsEvSt --GRS 상태
             ,(SELECT COUNT(TSS_CD) FROM IRIS_TSS_MGMT_MST X where A.PK_WBS_CD=X.PK_WBS_CD AND  X.PGS_STEP_CD='AL') as hasAltr -- 변경 내역 여부
            ,(SELECT TSS_CD FROM IRIS_TSS_MGMT_MST WHERE PGS_STEP_CD = 'PL' AND PK_WBS_CD=A.PK_WBS_CD) as plTssCd
            ,(SELECT TSS_CD FROM IRIS_TSS_MGMT_MST WHERE PGS_STEP_CD = 'PG' AND PK_WBS_CD=A.PK_WBS_CD) as pgTssCd
            ,(SELECT  TOP 1  TSS_CD FROM IRIS_TSS_MGMT_MST WHERE PGS_STEP_CD = 'AL' AND PK_WBS_CD=A.PK_WBS_CD) as alTssCd
            ,(SELECT TSS_CD FROM IRIS_TSS_MGMT_MST WHERE PGS_STEP_CD = 'CM' AND PK_WBS_CD=A.PK_WBS_CD) as cmTssCd
            ,(SELECT TSS_CD FROM IRIS_TSS_MGMT_MST WHERE PGS_STEP_CD = 'DC' AND PK_WBS_CD=A.PK_WBS_CD) as dcTssCd
            ,dbo.fn_getTssStepNm(#{tssCd}) as tssStepNm
            ,dbo.fn_getGrsStepNm(#{tssCd},'1') as grsStepNm
            ,dbo.fn_getQgateStepNm(A.WBS_CD,'1') as qgateStepNm
            ,a.GRS_YN as grsYn
            ,(select top 1  iif(TSS_CD_SN>0,'Y','N') from IRIS_GRS_EV_RSLT_RGST where TSS_CD=substring(#{tssCd},1,9)+'2' and DROP_YN!='Y' and GRS_EV_M_TYPE='AL' order by  TSS_CD_SN desc) as isGrsAl
            ,(select case when count(tss_cd)  > 0 then 'Y' else 'N' end
              from IRIS_GRS_EV_RSLT_RGST
              where DLBR_CRGR = #{_userSabun}
              and   TSS_CD_SN =  (select max(TSS_CD_SN) from IRIS_GRS_EV_RSLT_RGST where DLBR_CRGR = #{_userSabun})
              ) as grsBtnYn

          FROM IRIS_TSS_MGMT_MST A /*과제관리마스터*/
          LEFT JOIN IRIS_PRJ_RSST_MST B  /*프로젝트연구마스터*/
            ON A.PRJ_CD = B.PRJ_CD
         WHERE A.TSS_CD = #{tssCd}
    ]]>
    </select>
<!--  =====================================개요 시작 ============================================================================ -->
    <!--기술팀 과제  개요 조회 -->
    <select id="selectInfoSmry" parameterType="String"  resultType="hashmap" >
        <![CDATA[
            /*selectInfoSmry 기술팀 과제 개요 조회*/
            SELECT TOP 1 TSS_CD AS tssCd,
                   SMR_SMRY_TXT AS smrSmryTxt,
                   SMR_GOAL_TXT AS smrGoalTxt,
                   CTY_OT_PLN_M AS ctyOtPlnM,
                   isnull(NPROD_SALS_PLN_Y, '0') AS nprodSalsPlnY,
                   ATTC_FIL_ID AS attcFilId,
                   NPROD_NM AS nprodNm, --신제품명
                   ANCP_OT_PLN_DT AS ancpOtPlnDt, --예상출시일(계획)
                   QGATE3_DT AS qgate3Dt, --Qgate3(품질평가단계) 패스일자
                   FWD_PLN_TXT AS fwdPlnTxt, --사업화출시계획
                   FNO_PLN_TXT AS fnoPlnTxt, --향후 계획
                   ALTR_RSON_TXT AS altrRsonTxt,
                   ADD_RSON_TXT AS addRsonTxt,
                   DCAC_RSON_TXT AS dcacRsonTxt,
                   ALTR_ATTC_FIL_ID AS altrAttcFilId,
                   CMPL_ATTC_FIL_ID AS cmplAttcFilId,
                   DCAC_ATTC_FIL_ID AS dcacAttcFilId,
                   FRST_RGST_DT AS frstRgstDt,
                   FRST_RGST_ID AS frstRgstId,
                   LAST_MDFY_DT AS lastMdfyDt,
                   LAST_MDFY_ID AS lastMdfyId
              FROM IRIS_TSS_TCTM_SMRY
             WHERE TSS_CD = #{tssCd}
             ORDER BY  FRST_RGST_DT DESC

        ]]>
    </select>

    <!--기술팀 과제 개요 등록/수정-->
    <insert id="updateSmryInfo">
      <![CDATA[
        /*updateSmryInfo 기술팀 과제 개요 등록/수정*/
        MERGE INTO IRIS_TSS_TCTM_SMRY tbl
            USING (SELECT #{tssCd} AS TSS_CD) src
            ON (tbl.TSS_CD = src.TSS_CD)
            WHEN NOT MATCHED THEN
                INSERT
                       (
                       TSS_CD,
                       SMR_SMRY_TXT,
                       SMR_GOAL_TXT,
                       CTY_OT_PLN_M,
                       NPROD_SALS_PLN_Y,
                       ATTC_FIL_ID,
                       FRST_RGST_DT,
                       FRST_RGST_ID,
                       LAST_MDFY_DT,
                       LAST_MDFY_ID
                       )VALUES(
                       #{tssCd},
                       #{smrSmryTxt},
                       #{smrGoalTxt},
                       #{ctyOtPlnM},
                       #{nprodSalsPlnY},
                       #{attcFilId},
                        GETDATE(),
                        #{userId},
                        GETDATE(),
                        #{userId}
                       )
            WHEN MATCHED THEN
                UPDATE SET
                       SMR_SMRY_TXT = #{smrSmryTxt},
                       SMR_GOAL_TXT = #{smrGoalTxt},
                       CTY_OT_PLN_M = #{ctyOtPlnM},
                       NPROD_SALS_PLN_Y = #{nprodSalsPlnY},
                       ATTC_FIL_ID = #{attcFilId},
                       LAST_MDFY_DT = GETDATE(),
                       LAST_MDFY_ID = #{userId}
            ;
        ]]>
   </insert>
    <!--기술팀 과제 개요 복제-->
    <insert id="duplicateSmryInfo">
      <![CDATA[
/*duplicateSmryInfo 기술팀 과제 개요 복제*/
        INSERT
          INTO IRIS_TSS_TCTM_SMRY
               (
                   TSS_CD ,
                   SMR_SMRY_TXT ,
                   SMR_GOAL_TXT ,
                   CTY_OT_PLN_M ,
                   NPROD_SALS_PLN_Y ,
                   ATTC_FIL_ID ,
                     NPROD_NM,
                     ANCP_OT_PLN_DT,
                     QGATE3_DT,
                     FWD_PLN_TXT,
                     FNO_PLN_TXT,
                   ALTR_RSON_TXT ,
                   ADD_RSON_TXT ,
                   DCAC_RSON_TXT ,
                   ALTR_ATTC_FIL_ID ,
                   CMPL_ATTC_FIL_ID ,
                   DCAC_ATTC_FIL_ID ,
                   FRST_RGST_DT ,
                   FRST_RGST_ID ,
                   LAST_MDFY_DT ,
                   LAST_MDFY_ID
               )
        SELECT #{newTssCd} ,
               SMR_SMRY_TXT ,
               SMR_GOAL_TXT ,
               CTY_OT_PLN_M ,
               NPROD_SALS_PLN_Y ,
               ATTC_FIL_ID ,
               #{nprodNm},             --신제품명
               #{ancpOtPlnDt},         --예상출시일(계획)
               #{qgate3Dt},            --Qgate3(품질평가단계) 패스일자
               #{fwdPlnTxt},           --사업화출시계획
               #{fnoPlnTxt},           --향후 계획
               ]]>
                <choose>
                 <when test='altrRsonTxt != null and altrRsonTxt != ""'>#{altrRsonTxt},</when>
                 <otherwise>ALTR_RSON_TXT,</otherwise>
                </choose>
                <choose>
                 <when test='addRsonTxt != null and addRsonTxt != ""'>#{addRsonTxt},</when>
                 <otherwise>ADD_RSON_TXT,</otherwise>
                </choose>
                <choose>
                 <when test='dcacRsonTxt != null and dcacRsonTxt != ""'>#{dcacRsonTxt},</when>
                 <otherwise>DCAC_RSON_TXT,</otherwise>
                </choose>
                <choose>
                 <when test='altrAttcFilId != null and altrAttcFilId != ""'>#{altrAttcFilId},</when>
                 <otherwise>ALTR_ATTC_FIL_ID,</otherwise>
                </choose>
                <choose>
                 <when test='cmAttcFilId != null and cmAttcFilId != ""'>#{cmAttcFilId},</when>
                 <otherwise>CMPL_ATTC_FIL_ID,</otherwise>
                </choose>
                <choose>
                 <when test='dcAttcFilId != null and dcAttcFilIdId != ""'>#{dcAttcFilId},</when>
                 <otherwise>DCAC_ATTC_FIL_ID,</otherwise>
                </choose>
                <![CDATA[
               GETDATE() ,
               #{userId} ,
               GETDATE() ,
               #{userId}
          FROM IRIS_TSS_TCTM_SMRY
         WHERE TSS_CD = #{tssCd}
        ]]>
   </insert>

    <!-- -기술팀 과제 변경개요 사유 수정 -->
    <update id="updateSmryInfoAltrRson">
    <![CDATA[
    -- updateSmryInfoAltrRson 기술팀 과제 변경개요 사유 수정
        UPDATE IRIS_TSS_TCTM_SMRY  /*일반과제개요*/
           SET ALTR_RSON_TXT    = #{altrRsonTxt}
             , ADD_RSON_TXT     = #{addRsonTxt}
             , ALTR_ATTC_FIL_ID = #{altrAttcFilId}
             , LAST_MDFY_DT     = GETDATE()
             , LAST_MDFY_ID     = #{userId}
         WHERE TSS_CD = #{tssCd}
    ]]>
    </update>

    <!-- 개요 수정 (완료) -->
    <update id="updateSmryInfoCmpl">
    <![CDATA[
    /*updateSmryInfoCmpl 완료 개요 수정*/
        UPDATE IRIS_TSS_TCTM_SMRY
               SET NPROD_NM = #{nprodNm}, --신제품명
               ANCP_OT_PLN_DT = #{ancpOtPlnDt}, --예상출시일(계획)
               QGATE3_DT = #{qgate3Dt}, --Qgate3(품질평가단계) 패스일자
               FWD_PLN_TXT = #{fwdPlnTxt}, --사업화출시계획
               FNO_PLN_TXT = #{fnoPlnTxt}, --향후 계획
               CMPL_ATTC_FIL_ID = #{attcFilId}, --첨부파일
               LAST_MDFY_DT = GETDATE() ,
               LAST_MDFY_ID = #{userId}
         WHERE TSS_CD = #{tssCd}
    ]]>
    </update>

    <!-- 개요 수정 ( 중단) -->
    <update id="updateSmryInfoDcac">
    <![CDATA[
    /*updateSmryInfoDcac 중단 개요 수정*/
        UPDATE IRIS_TSS_TCTM_SMRY
               SET FNO_PLN_TXT = #{fnoPlnTxt}, --향후 계획
               DCAC_RSON_TXT =#{dcacRsonTxt}, --중단사유
               DCAC_ATTC_FIL_ID = #{attcFilId}, --첨부파일
               LAST_MDFY_DT = GETDATE() ,
               LAST_MDFY_ID = #{userId}
         WHERE TSS_CD = #{tssCd}
    ]]>
    </update>


    <!-- 개요 첨부파일 ID -->
    <select id="selectSmryFileId" resultType="hashmap">
    -- getTctmTssFileId 개요 첨부파일 ID
        SELECT ATTC_FIL_ID AS attcFilId
          FROM IRIS_TSS_TCTM_SMRY
         WHERE TSS_CD = #{pgTssCd}
    </select>
<!--  =====================================개요 끝 ============================================================================ -->
<!--  =====================================변경개요 시작 ============================================================================ -->
    <!-- 기술팀 변경목록 조회 -->
    <select id="selectAltrList" resultType="hashmap">
    <![CDATA[
    /*selectAltrListSmry 기술팀 변경개요목록 조회*/
        SELECT TSS_CD       AS tssCd      --과제코드
             , ALTR_SN      AS altrSn     --변경일련번호
             , PRVS         AS prvs       --항목
             , ALTR_PRE     AS altrPre    --변경전
             , ALTR_AFT     AS altrAft    --변경후
             , #{_userId}   AS userId
          FROM IRIS_TSS_SMRY_ALTR_LIST  /*변경개요 목록*/
         WHERE TSS_CD = #{tssCd}
    ]]>
    </select>


    <!-- 기술팀 변경목록 수정 -->
    <update id="updateAltrList">
    <![CDATA[
    /*updateAltrListSmry 기술팀 변경개요목록 수정*/
         MERGE IRIS_TSS_SMRY_ALTR_LIST A  /*변경개요 목록*/
         USING (SELECT #{tssCd} AS TSS_CD, CONVERT(numeric, CASE WHEN #{altrSn} = '' THEN NULL ELSE #{altrSn} END) AS ALTR_SN) B
            ON A.TSS_CD  = B.TSS_CD
           AND A.ALTR_SN = B.ALTR_SN
          WHEN NOT MATCHED THEN
        INSERT
             ( TSS_CD        --과제코드
             , ALTR_SN       --변경일련번호
             , PRVS          --항목
             , ALTR_PRE      --변경전
             , ALTR_AFT      --변경후
             , FRST_RGST_DT  --최초등록일시
             , FRST_RGST_ID  --최초등록자
             , LAST_MDFY_DT  --최종수정일시
             , LAST_MDFY_ID  --최종수정자
             )
        VALUES
             ( #{tssCd}
             , (SELECT ISNULL(MAX(X.ALTR_SN), 0) + 1 FROM IRIS_TSS_SMRY_ALTR_LIST X WHERE X.TSS_CD = #{tssCd})
             , #{prvs}
             , #{altrPre}
             , #{altrAft}
             , GETDATE()
             , #{userId}
             , GETDATE()
             , #{userId}
             )
          WHEN MATCHED THEN
        UPDATE
           SET PRVS         = #{prvs}
             , ALTR_PRE     = #{altrPre}
             , ALTR_AFT     = #{altrAft}
             , LAST_MDFY_DT = GETDATE()
             , LAST_MDFY_ID = #{userId}
             ;
    ]]>
    </update>


    <!-- 기술팀 변경목록 삭제 -->
    <delete id="deleteAltrList">
    <![CDATA[
    /*deleteAltrListSmry 기술팀 변경개요목록 삭제*/
        DELETE
          FROM IRIS_TSS_SMRY_ALTR_LIST  /*변경개요 목록*/
         WHERE TSS_CD  = #{tssCd}
           AND ALTR_SN = #{altrSn}
    ]]>
    </delete>
    <!-- =====================================변경개요 끝 ============================================================================ -->

    <!-- =====================================변경이력 시작 ============================================================================ -->
    <!--기술팀 과제  변경이력 조회 -->
    <select id="selectInfoAltrHisListAll" resultType="hashmap">
        <![CDATA[
        /*selectInfoAltrHis 기술팀 과제  변경이력 조회*/
        SELECT A.TSS_CD             AS tssCd
             , A.WBS_CD             AS wbsCd
             , A.PK_WBS_CD          AS pkWbsCd
             , C.PRVS               AS prvs
             , C.ALTR_PRE           AS altrPre
             , C.ALTR_AFT           AS altrAft
             , B.ALTR_RSON_TXT      AS altrRsonTxt
             , B.ADD_RSON_TXT       AS addRsonTxt
             , B.ALTR_ATTC_FIL_ID   AS altrAttcFilId
             , ISNULL(CONVERT(NVARCHAR, D.APPROVER_PROCESSDATE, 23), CONVERT(NVARCHAR, C.LAST_MDFY_DT, 23)) AS altrApprDd
          FROM IRIS_TSS_MGMT_MST A
               INNER JOIN  IRIS_TSS_TCTM_SMRY B
               ON A.TSS_CD = B.TSS_CD
               INNER JOIN IRIS_TSS_SMRY_ALTR_LIST C
               ON  A.TSS_CD = C.TSS_CD
               LEFT OUTER JOIN IRIS_COM_ITG_RDCS D
               ON A.TSS_CD = D.AFFR_CD
               AND D.APRDOCSTATE = 'A02' --고정값: A02(승인)
         WHERE A.PK_WBS_CD =  #{pkWbsCd}
           AND A.PGS_STEP_CD = 'AL' --고정값: AL(변경)
           AND A.TSS_ST = '104'
        ]]>
    </select>

    <!-- 기술팀 과제  변경이력 목록 조회  -->
    <select id="selectInfoAltrHisList"  resultType="hashmap">
    <![CDATA[
    /*selectInfoAltrHisList 변경이력 상세리스트 조회*/
     SELECT    A.TSS_CD             AS tssCd      --과제코드
             , A.ALTR_SN      AS altrSn     --변경일련번호
             , A.PRVS         AS prvs       --항목
             , A.ALTR_PRE     AS altrPre    --변경전
             , A.ALTR_AFT     AS altrAft    --변경후
             , ISNULL(CONVERT(NVARCHAR, D.APPROVER_PROCESSDATE, 23), CONVERT(NVARCHAR, A.LAST_MDFY_DT, 23)) AS altrApprDd
             , #{_userId}   AS userId
          FROM IRIS_TSS_SMRY_ALTR_LIST A /*변경개요 목록*/
                LEFT OUTER JOIN IRIS_COM_ITG_RDCS D
                  ON A.TSS_CD = D.AFFR_CD
                   AND D.APRDOCSTATE = 'A02' --고정값: A02(승인)
         WHERE TSS_CD = #{tssCd}
    ]]>
    </select>

    <!--기술팀 과제  변경이력 상세 조회 -->
    <select id="selectInfoAltrHisInfo"  resultType="hashmap">
    <![CDATA[
         /*selectInfoAltrHisInfo 변경이력 상세 조회*/
         SELECT    A.TSS_CD               AS tssCd              --과제코드
                 , A.ALTR_RSON_TXT      AS altrRsonTxt      --변경사유
                 , A.ADD_RSON_TXT         AS addRsonTxt        --추가사유
                 , A.ALTR_ATTC_FIL_ID   AS attcFilId        --첨부파일
              FROM IRIS_TSS_TCTM_SMRY A
             WHERE A.TSS_CD = #{tssCd}
    ]]>
    </select>

    <!-- =====================================변경이력 끝 ============================================================================ -->

   <!--기술팀 과제 등록/수정-->
   <insert id="updateInfo">
      <![CDATA[
/*updateInfo 기술팀과제 마스터 등록 및 수정*/
MERGE INTO dbo.IRIS_TSS_MGMT_MST tbl
    USING (SELECT #{tssCd} AS TSS_CD) src
    ON (tbl.TSS_CD = src.TSS_CD)
    WHEN NOT MATCHED THEN
        ]]>
      <![CDATA[
        INSERT
               (
               PRJ_CD,
               TSS_CD,
               PGS_STEP_CD,
               TSS_SCN_CD,
               WBS_CD,
               PK_WBS_CD,
               DEPT_CODE,
               PPSL_MBD_CD,
               BIZ_DPT_CD,
               TSS_NM,
               SA_SABUN_NEW,
               TSS_ATTR_CD,
               TSS_STRT_DD,
               TSS_FNH_DD,
               FRST_RGST_DT,
               FRST_RGST_ID,
               LAST_MDFY_DT,
               LAST_MDFY_ID,
               DEL_YN,
               PROD_G,
               RSST_SPHE,
               TSS_TYPE,
               SA_SABUN_NAME,
               DEPT_NAME,
               PRJ_NM,
               CUST_SQLT,
               TSS_SMRY_TXT
               )VALUES(
                #{prjCd},
                #{tssCd},
                #{pgsStepCd},
                #{tssScnCd},
                #{wbsCd},
                CASE WHEN #{createMod} = 'Altr' THEN #{pkWbsCd} ELSE #{wbsCd} END,
                #{deptCode},
                #{ppslMbdCd},
                #{bizDptCd},
                #{tssNm},
                #{saSabunNew},
                #{tssAttrCd},
                #{tssStrtDd},
                #{tssFnhDd},
                GETDATE(),
                #{userId},
                GETDATE(),
                #{userId},
                'N',
                #{prodG},
                #{rsstSphe},
                #{tssType},
                #{saSabunName},
                #{deptName},
                #{prjNm},
               #{custSqlt},
               #{tssSmryTxt}
               )
    WHEN MATCHED THEN
        UPDATE SET
            PRJ_CD = #{prjCd},
            PGS_STEP_CD = #{pgsStepCd},
            TSS_SCN_CD = #{tssScnCd},
            WBS_CD = #{wbsCd},
            PK_WBS_CD = #{pkWbsCd},
            DEPT_CODE = #{deptCode},
            PPSL_MBD_CD = #{ppslMbdCd},
            BIZ_DPT_CD = #{bizDptCd},
            TSS_NM = #{tssNm},
            SA_SABUN_NEW = #{saSabunNew},
            TSS_ATTR_CD = #{tssAttrCd},
            TSS_STRT_DD = #{tssStrtDd},
            TSS_FNH_DD = #{tssFnhDd},
            LAST_MDFY_DT = GETDATE(),
            LAST_MDFY_ID = #{userId},
            PROD_G = #{prodG},
            RSST_SPHE = #{rsstSphe},
            TSS_TYPE = #{tssType},
            SA_SABUN_NAME = #{saSabunName},
            DEPT_NAME = #{deptName},
            PRJ_NM = #{prjNm},
           CUST_SQLT = #{custSqlt},
           TSS_SMRY_TXT = #{tssSmryTxt }

    ;
        ]]>
   </insert>


    <!--기술팀 과제 마스터 복제-->
    <insert id="duplicateInfo">
        -- insertGenTssCmplMst 마스터 신규
        <selectKey keyProperty="newTssCd" resultType="String" order="BEFORE">
            <![CDATA[
            SELECT #{pkWbsCd} + REPLICATE('0', 4 - LEN(COUNT(X.TSS_CD)+1)) + CAST(COUNT(X.TSS_CD) + 1 AS NVARCHAR(4))
              FROM IRIS_TSS_MGMT_MST X
             WHERE X.PK_WBS_CD = #{pkWbsCd}
        ]]>
        </selectKey>
        <![CDATA[
        INSERT
          INTO IRIS_TSS_MGMT_MST  /*과제관리마스터*/
             ( PRJ_CD            --프로젝트코드
             , TSS_CD            --과제코드
             , PGS_STEP_CD       --진행단계코드
             , TSS_SCN_CD        --과제구분코드
             , WBS_CD            --WBS코드
             , PK_WBS_CD         --WBS코드
             , DEPT_CODE         --조직코드(소속)
             , PPSL_MBD_CD       --발의주체코드
             , BIZ_DPT_CD        --사업부문코드
             , TSS_NM            --과제명
             , SA_SABUN_NEW      --과제리더사번
             , TSS_ATTR_CD       --과제속성코드
             , TSS_STRT_DD       --과제시작일
             , TSS_FNH_DD        --과제종료일
             , ALTR_B_STRT_DD    --변경전시작일
             , ALTR_B_FNH_DD     --변경전종료일
             , ALTR_NX_STRT_DD   --변경후시작일
             , ALTR_NX_FNH_DD    --변경후종료일
             , CMPL_B_STRT_DD    --완료전시작일
             , CMPL_B_FNH_DD     --완료전종료일
             , CMPL_NX_STRT_DD   --완료후시작일
             , CMPL_NX_FNH_DD    --완료후종료일
             , DCAC_B_STRT_DD    --중단전시작일
             , DCAC_B_FNH_DD     --중단전종료일
             , DCAC_NX_STRT_DD   --중단후시작일
             , DCAC_NX_FNH_DD    --중단후종료일
             , COO_INST_CD       --협력기관코드
             , SUPV_OPS_NM       --주관부서명
             , EXRS_INST_NM      --전담기관명
             , BIZ_NM            --사업명
             , TSS_ST            --과제상태
             , TSS_NOS_ST        --과제차수상태
             , TSS_ST_TXT        --과제상태의견
             , PROD_G
             , RSST_SPHE
             , TSS_TYPE
                ,SA_SABUN_NAME
                ,DEPT_NAME
                ,PRJ_NM
                ,CUST_SQLT
                ,TSS_SMRY_TXT
             , FRST_RGST_DT      --최초등록일시
             , FRST_RGST_ID      --최초등록자
             , LAST_MDFY_DT      --최종수정일시
             , LAST_MDFY_ID      --최종수정자
             )
        SELECT PRJ_CD
             , #{newTssCd}
             , #{pgsStepCd}
             , #{tssScnCd}
             , WBS_CD
             , PK_WBS_CD
             , DEPT_CODE
             , PPSL_MBD_CD
             , BIZ_DPT_CD
             , TSS_NM
             , SA_SABUN_NEW
             , TSS_ATTR_CD
             , TSS_STRT_DD
             , TSS_FNH_DD
             , ALTR_B_STRT_DD
             , ALTR_B_FNH_DD
             , ALTR_NX_STRT_DD
             , ALTR_NX_FNH_DD
             , #{cmplBStrtDd}
             , #{cmplBFnhDd}
             , CMPL_NX_STRT_DD
             , CMPL_NX_FNH_DD
              ,#{dcacBStrtDd}
              ,#{dcacBFnhDd}
             , DCAC_NX_STRT_DD
             , DCAC_NX_FNH_DD
             , COO_INST_CD
             , SUPV_OPS_NM
             , EXRS_INST_NM
             , BIZ_NM
             , #{tssSt}
             , #{tssNosSt}
             , TSS_ST_TXT
             , PROD_G
             , RSST_SPHE
             , TSS_TYPE
            ,SA_SABUN_NAME
            ,DEPT_NAME
            ,PRJ_NM
            ,CUST_SQLT
            ,TSS_SMRY_TXT
             , GETDATE()
             , #{userId}
             , GETDATE()
             , #{userId}
          FROM IRIS_TSS_MGMT_MST  /*과제관리마스터*/
         WHERE TSS_CD = #{tssCd}
    ]]>
    </insert>


    <!-- 완료 실적일자 수정 -->
    <update id="updateInfoCmpl">
    <![CDATA[
    /*updateInfoCmpl 완료 실적일자 수정*/
        UPDATE IRIS_TSS_MGMT_MST
           SET CMPL_B_STRT_DD = #{cmplBStrtDd}
             , CMPL_B_FNH_DD  = #{cmplBFnhDd}
             , LAST_MDFY_DT   = GETDATE()
             , LAST_MDFY_ID   = #{userId}
         WHERE TSS_CD = #{tssCd}
    ]]>
    </update>
    <!-- 중단 실적일자 수정 -->
    <update id="updateInfoDcac">
    <![CDATA[
    /*updateInfoDcac 중단 실적일자 수정*/
        UPDATE IRIS_TSS_MGMT_MST
               SET DCAC_B_STRT_DD= #{dcacBStrtDd} --중단전시작일
               ,DCAC_B_FNH_DD= #{dcacBFnhDd} --중단전종료일
               ,LAST_MDFY_DT = GETDATE()
               ,LAST_MDFY_ID = #{userId}
         WHERE TSS_CD = #{tssCd}
    ]]>
    </update>
    <!-- =====================================기본 삭제 시작 ============================================================================ -->

   <!--기술팀 과제 삭제-->
   <delete id="deleteInfo">
   <![CDATA[
/*deleteInfo 기술팀 과제 삭제*/
    DELETE
      FROM IRIS_TSS_MGMT_MST
     WHERE TSS_CD = #{tssCd}
       ]]>
   </delete>

   <!--기술팀 과제 개요 삭제-->
   <delete id="deleteSmryInfo">
   <![CDATA[
/*deleteSmryInfo 기술팀 과제 개요 삭제*/
    DELETE
      FROM IRIS_TSS_TCTM_SMRY
     WHERE TSS_CD = #{tssCd}
       ]]>
   </delete>

   <!--기술팀 과제 변경개요 삭제-->
   <delete id="deleteAltrInfo">
   <![CDATA[
/*deleteAltrInfo 기술팀 과제 변경개요 삭제*/
    DELETE
      FROM IRIS_TSS_SMRY_ALTR_LIST
     WHERE TSS_CD = #{tssCd}
       ]]>
   </delete>

   <!--기술팀 과제 산출물-->
   <delete id="deleteGoalInfo">
   <![CDATA[
/*deleteGoalInfo 기술팀 과제 산출물*/
    DELETE
      FROM IRIS_TSS_YLD_ITM
     WHERE TSS_CD = #{tssCd}
       ]]>
   </delete>

    <!--기술팀 과제 GRS 평가표-->
    <delete id="deleteEv">
   <![CDATA[
/*deleteEv 기술팀 과제 GRS 평가표*/
    DELETE
      FROM IRIS_GRS_EV_RSLT_RGST
         WHERE TSS_CD = #{tssCd}
       ]]>
   </delete>

    <!--기술팀 과제 GRS 평가표 점수-->
    <delete id="deleteEvResult">
   <![CDATA[
/*deleteEvResult 기술팀 과제 GRS 평가표 점수*/
    DELETE
      FROM IRIS_GRS_EV_STD_RSLT_RGST
     WHERE TSS_CD = #{tssCd}
       ]]>
   </delete>

    <!-- =====================================기본 삭제 끝 ============================================================================ -->


    <insert id="insertTctmTssAltrSmry">
    <![CDATA[
/*insertTctmTssAltrSmry 계획 >> 진행*/
        INSERT
          INTO IRIS_TSS_TCTM_SMRY  /*기술팀과제개요*/
             ( TSS_CD             --과제코드
             , SMR_SMRY_TXT
             , SMR_GOAL_TXT
             , CTY_OT_PLN_M       --상품출시변경월
             , NPROD_SALS_PLN_Y   --신제품매출변경Y
             , ATTC_FIL_ID             --첨부파일
             , ALTR_RSON_TXT           --변경사유
             , ADD_RSON_TXT            --추가사유
             , DCAC_RSON_TXT           --중단사유
             , ALTR_ATTC_FIL_ID             --첨부파일
             , CMPL_ATTC_FIL_ID             --첨부파일
             , DCAC_ATTC_FIL_ID             --첨부파일
             , FRST_RGST_DT       --최초등록일시
             , FRST_RGST_ID       --최초등록자
             , LAST_MDFY_DT       --최종수정일시
             , LAST_MDFY_ID       --최종수정자
             )
        SELECT #{tssCd}
             , SMR_SMRY_TXT
             , SMR_GOAL_TXT
             , CTY_OT_PLN_M
             , NPROD_SALS_PLN_Y
             , CASE WHEN ISNULL(#{attcFilId}, '') = '' THEN ATTC_FIL_ID ELSE #{attcFilId} END
             , ALTR_RSON_TXT
             , ADD_RSON_TXT
             , DCAC_RSON_TXT
             , ALTR_ATTC_FIL_ID
             , CMPL_ATTC_FIL_ID
             , DCAC_ATTC_FIL_ID
             , GETDATE()
             , #{userId}
             , GETDATE()
             , #{userId}
          FROM IRIS_TSS_TCTM_SMRY
         WHERE TSS_CD = #{pgTssCd}
    ]]>
    </insert>


    <update id="updateTctmTssAltrSmry">
    <![CDATA[
/*updateTctmTssAltrSmry 변경 -> 진행데이터에 update*/
        UPDATE T1
           SET
             t1.SMR_SMRY_TXT        = t1.SMR_SMRY_TXT
             , t1.SMR_GOAL_TXT        = t1.SMR_GOAL_TXT
             , t1.CTY_OT_PLN_M        = t2.CTY_OT_PLN_M
             , t1.NPROD_SALS_PLN_Y    = t2.NPROD_SALS_PLN_Y
             , t1.ATTC_FIL_ID         = t2.ATTC_FIL_ID
             , t1.LAST_MDFY_DT        = GETDATE()
             , t1.LAST_MDFY_ID        = #{userId}
          FROM (SELECT
                     SMR_SMRY_TXT
                     , SMR_GOAL_TXT
                     , CTY_OT_PLN_M
                     , NPROD_SALS_PLN_Y
                     , ATTC_FIL_ID
                     , LAST_MDFY_DT
                     , LAST_MDFY_ID
                  FROM IRIS_TSS_TCTM_SMRY
                 WHERE tss_cd =  #{psTssCd} )  T1
             , IRIS_TSS_TCTM_SMRY T2
         WHERE t2.TSS_CD = #{tssCd}
    ]]>
    </update>


    <!-- 개요 업로드 파일 산출물 연결-->
    <update id="updateYldFile">
        --updateYldFile 기술팀과제 산출물 연결
        UPDATE Y
        SET
            Y.YLD_ITM_NM     = F.FIL_NM
            , Y.ATTC_FIL_ID  = F.ATTC_FIL_ID
            , Y.LAST_MDFY_DT = GETDATE()
            , Y.LAST_MDFY_ID = F.LAST_MDFY_ID
        FROM IRIS_TSS_YLD_ITM Y, IRIS_COM_ATTC_FIL F
        WHERE
            Y.TSS_CD = #{tssCd}
            AND Y.YLD_ITM_TYPE = #{yldItmType}
            AND F.ATTC_FIL_ID = #{attcFilId}
            and F.DEL_YN = 'N'
    </update>




    <select id="selectStTssCd" resultType="hashmap">
        <![CDATA[
          /*selectStTssCd 과제 상태별 과제코드*/
            SELECT
            (SELECT TSS_CD FROM IRIS_TSS_MGMT_MST WHERE PGS_STEP_CD = 'PL' AND PK_WBS_CD=substring(#{tssCd},1,6)) as plTssCd,
            (SELECT TSS_CD FROM IRIS_TSS_MGMT_MST WHERE PGS_STEP_CD = 'PG' AND PK_WBS_CD=substring(#{tssCd},1,6)) as pgTssCd,
            (SELECT  TOP 1  TSS_CD FROM IRIS_TSS_MGMT_MST WHERE PGS_STEP_CD = 'AL' AND PK_WBS_CD=substring(#{tssCd},1,6)) as alTssCd,
            (SELECT TSS_CD FROM IRIS_TSS_MGMT_MST WHERE PGS_STEP_CD = 'CM' AND PK_WBS_CD=substring(#{tssCd},1,6)) as cmTssCd,
            (SELECT TSS_CD FROM IRIS_TSS_MGMT_MST WHERE PGS_STEP_CD = 'DC' AND PK_WBS_CD=substring(#{tssCd},1,6)) as dcTssCd
        ]]>
    </select>

</mapper>
